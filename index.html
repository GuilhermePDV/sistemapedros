<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Barbearia Pedro's</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 h-full"><!-- Toast Container -->
  <div id="toast-container"></div><!-- Login Screen -->
  <div id="login-screen" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
   <div class="max-w-md w-full space-y-8">
    <div class="text-center">
     <h2 class="mt-6 text-3xl font-bold text-gray-900" id="business-title">Barbearia Pedro's</h2>
     <p class="mt-2 text-sm text-gray-600">Sistema de Gest√£o</p>
    </div><!-- Demo credentials info -->
    <div class=" ">
     <div class="text-xs text-blue-700 space-y-1">


     </div>
    </div>
    <form id="login-form" class="mt-8 space-y-6">
     <div class="space-y-4">
      <div><label for="email" class="block text-sm font-medium text-gray-700">Email</label> <input id="email" name="email" type="email" required placeholder="admin@barbearia.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div><label for="password" class="block text-sm font-medium text-gray-700">Senha</label> <input id="password" name="password" type="password" required placeholder="123456" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
      </div>
     </div><button type="submit" id="login-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"> <span id="login-text">Entrar</span>
      <div id="login-spinner" class="loading-spinner ml-2 hidden"></div></button>
    </form>
    </div>
   </div>
  </div><!-- Main App -->
  <div id="main-app" class="hidden h-full"><!-- Sidebar -->
   <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg sidebar-transition">
    <div class="flex flex-col h-full">
     <div class="flex items-center justify-between p-4 border-b">
      <h1 class="text-xl font-bold text-gray-900" id="sidebar-title">Barbearia Pedro's</h1><button id="sidebar-toggle" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-600">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <nav class="flex-1 p-4 space-y-2"><a href="#" data-section="dashboard" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 active">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
       </svg> Dashboard </a> <a href="#" data-section="appointments" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
       </svg> Agendamentos </a> <a href="#" data-section="clients" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
       </svg> Clientes </a> <a href="#" data-section="services" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
       </svg> Servi√ßos </a> <a href="#" data-section="products" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
       </svg> Produtos </a> <a href="#" data-section="cashier" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
       </svg> Caixa </a> <a href="#" data-section="reports" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
       </svg> Relat√≥rios </a> <a href="#" data-section="users" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 admin-only">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
       </svg> Usu√°rios </a> <a href="#" data-section="settings" class="nav-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 admin-only">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
       </svg> Configura√ß√µes </a>
     </nav>
     <div class="p-4 border-t">
      <div class="flex items-center space-x-3 mb-3">
       <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-medium" id="user-avatar">U</span>
       </div>
       <div>
        <p class="text-sm font-medium text-gray-900" id="user-name">Usu√°rio</p>
        <p class="text-xs text-gray-500" id="user-role">Barbeiro</p>
       </div>
      </div><button id="logout-btn" class="w-full flex items-center justify-center px-4 py-2 text-sm text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
       <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
       </svg> Sair </button>
     </div>
    </div>
   </div><!-- Main Content -->
   <div class="lg:ml-64"><!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
     <div class="flex items-center justify-between px-4 py-4">
      <div class="flex items-center"><button id="mobile-menu-btn" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-600 mr-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg></button>
       <h1 class="text-2xl font-bold text-gray-900" id="page-title">Dashboard</h1>
      </div>
      <div class="flex items-center space-x-4"><span class="text-sm text-gray-500" id="current-date"></span>
      </div>
     </div>
    </header><!-- Content Area -->
    <main class="p-6"><!-- Dashboard Section -->
     <div id="dashboard-section" class="section">
      <div class="mb-6">
       <h2 class="text-xl font-semibold text-gray-900 mb-2" id="welcome-text">Bem-vindo ao sistema de gest√£o</h2>
       <p class="text-gray-600">Gerencie sua barbearia de forma eficiente</p>
      </div><!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <div class="flex items-center">
         <div class="p-2 bg-blue-100 rounded-lg">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Agendamentos Hoje</p>
          <p class="text-2xl font-bold text-gray-900" id="today-appointments">0</p>
         </div>
        </div>
       </div>
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <div class="flex items-center">
         <div class="p-2 bg-green-100 rounded-lg">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Receita Total Hoje</p>
          <p class="text-2xl font-bold text-gray-900" id="today-revenue">R$ 0,00</p>
         </div>
        </div>
       </div>
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <div class="flex items-center">
         <div class="p-2 bg-purple-100 rounded-lg">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Minha Comiss√£o Hoje</p>
          <p class="text-2xl font-bold text-purple-600" id="my-commission">R$ 0,00</p>
         </div>
        </div>
       </div>
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <div class="flex items-center">
         <div class="p-2 bg-orange-100 rounded-lg">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total Clientes</p>
          <p class="text-2xl font-bold text-gray-900" id="total-clients">0</p>
         </div>
        </div>
       </div>
      </div><!-- Detalhamento de Comiss√µes (apenas para barbeiros) -->
      <div id="commission-details" class="mb-8 hidden">
       <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
        <h3 class="text-lg font-bold mb-4">üí∞ Detalhamento das Minhas Comiss√µes Hoje</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div class="bg-white bg-opacity-20 rounded-lg p-4">
          <div class="flex items-center justify-between">
           <div>
            <p class="text-purple-100 text-sm">Servi√ßos</p>
            <p class="text-2xl font-bold" id="services-commission">R$ 0,00</p>
           </div>
           <div class="text-purple-200">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
           </div>
          </div>
          <p class="text-xs text-purple-200 mt-1" id="services-percentage">0% de comiss√£o</p>
         </div>
         <div class="bg-white bg-opacity-20 rounded-lg p-4">
          <div class="flex items-center justify-between">
           <div>
            <p class="text-purple-100 text-sm">Produtos</p>
            <p class="text-2xl font-bold" id="products-commission">R$ 0,00</p>
           </div>
           <div class="text-purple-200">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
           </div>
          </div>
          <p class="text-xs text-purple-200 mt-1" id="products-percentage">0% de comiss√£o</p>
         </div>
         <div class="bg-white bg-opacity-20 rounded-lg p-4">
          <div class="flex items-center justify-between">
           <div>
            <p class="text-purple-100 text-sm">Total</p>
            <p class="text-2xl font-bold" id="total-commission">R$ 0,00</p>
           </div>
           <div class="text-purple-200">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
           </div>
          </div>
          <p class="text-xs text-purple-200 mt-1">Comiss√£o total do dia</p>
         </div>
        </div>
       </div>
      </div><!-- Quick Actions -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">A√ß√µes R√°pidas</h3>
        <div class="space-y-3"><button class="w-full text-left px-4 py-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors" data-section="appointments"> Novo Agendamento </button> <button class="w-full text-left px-4 py-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors" data-section="clients"> Cadastrar Cliente </button> <button class="w-full text-left px-4 py-3 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors" data-section="cashier"> Abrir Caixa </button>
        </div>
       </div>
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pr√≥ximos Agendamentos</h3>
        <div id="next-appointments" class="space-y-3">
         <p class="text-gray-500 text-sm">Nenhum agendamento encontrado</p>
        </div>
       </div>
       <div class="bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Status do Caixa</h3>
        <div id="cashier-status">
         <p class="text-gray-500 text-sm">Caixa fechado</p><button id="open-cashier-btn" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Abrir Caixa </button>
        </div>
       </div>
      </div>
     </div><!-- Other sections will be loaded dynamically -->
     <div id="appointments-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Agendamentos</h2><button id="new-appointment-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Novo Agendamento </button>
       </div>
       <div id="appointments-list">
        <p class="text-gray-500">Carregando agendamentos...</p>
       </div>
      </div>
     </div>
     <div id="clients-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Clientes</h2><button id="new-client-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Novo Cliente </button>
       </div>
       <div id="clients-list">
        <p class="text-gray-500">Carregando clientes...</p>
       </div>
      </div>
     </div>
     <div id="services-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Servi√ßos</h2><button id="new-service-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Novo Servi√ßo </button>
       </div>
       <div id="services-list">
        <p class="text-gray-500">Carregando servi√ßos...</p>
       </div>
      </div>
     </div>
     <div id="products-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Produtos</h2><button id="new-product-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Novo Produto </button>
       </div>
       <div id="products-list">
        <p class="text-gray-500">Carregando produtos...</p>
       </div>
      </div>
     </div>
     <div id="cashier-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <h2 class="text-xl font-semibold text-gray-900 mb-6">Controle de Caixa</h2>
       <div id="cashier-content">
        <p class="text-gray-500">Carregando informa√ß√µes do caixa...</p>
       </div>
      </div>
     </div>
     <div id="reports-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <h2 class="text-xl font-semibold text-gray-900 mb-6">Relat√≥rios</h2>
       <div id="reports-content">
        <p class="text-gray-500">Carregando relat√≥rios...</p>
       </div>
      </div>
     </div>
     <div id="users-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Usu√°rios</h2><button id="new-user-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Novo Usu√°rio </button>
       </div>
       <div id="users-list">
        <p class="text-gray-500">Carregando usu√°rios...</p>
       </div>
      </div>
     </div>
     <div id="settings-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-sm border p-6">
       <h2 class="text-xl font-semibold text-gray-900 mb-6">Configura√ß√µes</h2>
       <div id="settings-content">
        <p class="text-gray-500">Carregando configura√ß√µes...</p>
       </div>
      </div>
     </div>
    </main>
   </div>
  </div><!-- Modal Container -->
  <div id="modal-container"></div>
  <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDX90uVvNOF6XNaDA6otD4QqJmHYgdgf4I",
            authDomain: "barbearia-pedros.firebaseapp.com",
            projectId: "barbearia-pedros",
            storageBucket: "barbearia-pedros.firebasestorage.app",
            messagingSenderId: "642491845834",
            appId: "1:642491845834:web:38a41662f06de8e286f833"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global State
        let currentUser = null;
        let currentSection = 'dashboard';
        let cashierOpen = false;

        // Default Config
        const defaultConfig = {
            business_name: "Barbearia Pedro's",
            welcome_message: "Bem-vindo ao sistema de gest√£o"
        };

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('pt-BR').format(date);
        }

        function showLoading(element) {
            element.innerHTML = '<div class="flex items-center justify-center py-8"><div class="loading-spinner"></div></div>';
        }

        // Authentication Functions
        async function login(email, password) {
            try {
                // First, try to find user in Firestore
                const usersQuery = await db.collection('users').where('email', '==', email).get();
                
                if (usersQuery.empty) {
                    // If user doesn't exist in Firestore, try to create it
                    if (email === 'admin@barbearia.com' && password === '123456') {
                        await createFirstAdmin();
                        // Try login again after creating admin
                        return await login(email, password);
                    } else {
                        showToast('Usu√°rio n√£o encontrado no sistema', 'error');
                        return;
                    }
                }
                
                const userDoc = usersQuery.docs[0];
                const userData = userDoc.data();
                
                // Simple password check (in production, use proper hashing)
                if (userData.password && userData.password === password) {
                    currentUser = { id: userDoc.id, ...userData };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainApp();
                    showToast('Login realizado com sucesso!');
                } else if (!userData.password) {
                    // For users without password field, try Firebase Auth
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        currentUser = { id: userDoc.id, ...userData };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showMainApp();
                        showToast('Login realizado com sucesso!');
                    } catch (authError) {
                        console.error('Firebase Auth error:', authError);
                        showToast('Email ou senha incorretos', 'error');
                    }
                } else {
                    showToast('Email ou senha incorretos', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Erro ao fazer login: ' + error.message, 'error');
            }
        }

        async function createFirstAdmin() {
            try {
                // Check if admin user already exists
                const adminQuery = await db.collection('users').where('email', '==', 'admin@barbearia.com').limit(1).get();
                
                if (adminQuery.empty) {
                    // Create admin user directly in Firestore
                    const email = 'admin@barbearia.com';
                    const password = '123456';
                    
                    await db.collection('users').add({
                        name: 'Administrador',
                        email: email,
                        password: password, // Store password directly (for demo purposes)
                        role: 'admin',
                        serviceCommissionPercentage: 0,
                        productCommissionPercentage: 0,
                        status: 'ativo',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showToast('Usu√°rio administrador criado! Email: admin@barbearia.com | Senha: 123456', 'success');
                    
                    // Auto-fill login form
                    document.getElementById('email').value = email;
                    document.getElementById('password').value = password;
                } else {
                    console.log('Admin user already exists');
                }
            } catch (error) {
                console.error('Error creating first admin:', error);
                // Don't show error to user as this is automatic
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginScreen();
                showToast('Logout realizado com sucesso!');
            } catch (error) {
                showToast('Erro ao fazer logout', 'error');
            }
        }

        // UI Functions
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUserInfo();
            loadDashboard();
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Barbeiro';
                document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
                
                // Show/hide admin sections
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => {
                    el.style.display = currentUser.role === 'admin' ? 'flex' : 'none';
                });
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'bg-blue-50', 'text-blue-700');
                item.classList.add('text-gray-700');
            });
            
            const activeItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeItem) {
                activeItem.classList.add('active', 'bg-blue-50', 'text-blue-700');
                activeItem.classList.remove('text-gray-700');
            }
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                appointments: 'Agendamentos',
                clients: 'Clientes',
                services: 'Servi√ßos',
                products: 'Produtos',
                cashier: 'Caixa',
                reports: 'Relat√≥rios',
                users: 'Usu√°rios',
                settings: 'Configura√ß√µes'
            };
            
            document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';
            currentSection = sectionName;
            
            // Load section content
            loadSectionContent(sectionName);
        }

        async function loadSectionContent(sectionName) {
            switch (sectionName) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'appointments':
                    await loadAppointments();
                    break;
                case 'clients':
                    await loadClients();
                    break;
                case 'services':
                    await loadServices();
                    break;
                case 'products':
                    await loadProducts();
                    break;
                case 'cashier':
                    await loadCashier();
                    break;
                case 'reports':
                    await loadReports();
                    break;
                case 'users':
                    if (currentUser.role === 'admin') {
                        await loadUsers();
                    }
                    break;
                case 'settings':
                    if (currentUser.role === 'admin') {
                        await loadSettings();
                    }
                    break;
            }
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Load today's appointments
                const appointmentsQuery = await db.collection('appointments')
                    .where('date', '==', todayStr)
                    .get();
                
                document.getElementById('today-appointments').textContent = appointmentsQuery.size;
                
                // Calculate today's revenue from appointments
                let todayRevenue = 0;
                appointmentsQuery.forEach(doc => {
                    const appointment = doc.data();
                    if (appointment.status === 'conclu√≠do') {
                        todayRevenue += appointment.totalValue || 0;
                    }
                });
                
                // Calculate today's revenue from sales and commissions
                let totalSalesRevenue = 0;
                let myTotalCommission = 0;
                let myServicesCommission = 0;
                let myProductsCommission = 0;
                
                try {
                    const cashierDoc = await db.collection('cashier').doc(todayStr).get();
                    if (cashierDoc.exists) {
                        const sales = cashierDoc.data().sales || [];
                        
                        sales.forEach(sale => {
                            totalSalesRevenue += sale.total || 0;
                            
                            // Calculate user's commission from sales
                            if (sale.userId === currentUser.id) {
                                myTotalCommission += sale.totalCommission || 0;
                                myServicesCommission += sale.serviceCommission || 0;
                                myProductsCommission += sale.productCommission || 0;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading sales data:', error);
                }
                
                // Update dashboard values
                const totalRevenue = todayRevenue + totalSalesRevenue;
                document.getElementById('today-revenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('my-commission').textContent = formatCurrency(myTotalCommission);
                
                // Show commission details for barbeiros
                if (currentUser.role === 'barbeiro') {
                    const commissionDetails = document.getElementById('commission-details');
                    commissionDetails.classList.remove('hidden');
                    
                    document.getElementById('services-commission').textContent = formatCurrency(myServicesCommission);
                    document.getElementById('products-commission').textContent = formatCurrency(myProductsCommission);
                    document.getElementById('total-commission').textContent = formatCurrency(myTotalCommission);
                    document.getElementById('services-percentage').textContent = `${currentUser.serviceCommissionPercentage || 0}% de comiss√£o`;
                    document.getElementById('products-percentage').textContent = `${currentUser.productCommissionPercentage || 0}% de comiss√£o`;
                } else {
                    document.getElementById('commission-details').classList.add('hidden');
                }
                
                // Load total clients
                const clientsQuery = await db.collection('clients').get();
                document.getElementById('total-clients').textContent = clientsQuery.size;
                
                // Load next appointments
                await loadNextAppointments();
                
                // Check cashier status
                await checkCashierStatus();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Erro ao carregar dashboard', 'error');
            }
        }

        async function loadNextAppointments() {
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                const query = db.collection('appointments')
                    .where('date', '>=', todayStr)
                    .where('status', '==', 'agendado')
                    .orderBy('date')
                    .orderBy('time')
                    .limit(5);
                
                const snapshot = await query.get();
                const container = document.getElementById('next-appointments');
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum agendamento encontrado</p>';
                    return;
                }
                
                let html = '';
                for (const doc of snapshot.docs) {
                    const appointment = doc.data();
                    
                    // Get client and service names
                    const clientDoc = await db.collection('clients').doc(appointment.clientId).get();
                    const serviceDoc = await db.collection('services').doc(appointment.serviceId).get();
                    
                    const clientName = clientDoc.exists ? clientDoc.data().name : 'Cliente n√£o encontrado';
                    const serviceName = serviceDoc.exists ? serviceDoc.data().name : 'Servi√ßo n√£o encontrado';
                    
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900">${clientName}</p>
                                <p class="text-xs text-gray-500">${serviceName}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">${formatDate(new Date(appointment.date))}</p>
                                <p class="text-xs text-gray-500">${appointment.time}</p>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading next appointments:', error);
                document.getElementById('next-appointments').innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar agendamentos</p>';
            }
        }

        async function checkCashierStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const cashierDoc = await db.collection('cashier').doc(today).get();
                
                const statusContainer = document.getElementById('cashier-status');
                
                if (cashierDoc.exists && cashierDoc.data().isOpen) {
                    cashierOpen = true;
                    const data = cashierDoc.data();
                    statusContainer.innerHTML = `
                        <div class="text-green-600">
                            <p class="font-medium">Caixa Aberto</p>
                            <p class="text-sm">Valor inicial: ${formatCurrency(data.initialAmount || 0)}</p>
                            <p class="text-sm">Movimenta√ß√µes: ${data.movements ? data.movements.length : 0}</p>
                        </div>
                        <button id="close-cashier-btn" class="mt-3 w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Fechar Caixa
                        </button>
                    `;
                    
                    document.getElementById('close-cashier-btn').addEventListener('click', closeCashier);
                } else {
                    cashierOpen = false;
                    statusContainer.innerHTML = `
                        <p class="text-gray-500 text-sm">Caixa fechado</p>
                        <button id="open-cashier-btn" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Abrir Caixa
                        </button>
                    `;
                    
                    document.getElementById('open-cashier-btn').addEventListener('click', openCashier);
                }
            } catch (error) {
                console.error('Error checking cashier status:', error);
            }
        }

        // Real Firebase functions for all sections
        async function loadAppointments() {
            const container = document.getElementById('appointments-list');
            showLoading(container);
            
            try {
                // Get current date with offset
                const today = new Date();
                const currentDate = new Date(today);
                currentDate.setDate(today.getDate() + currentDayOffset);
                const currentDateStr = currentDate.toISOString().split('T')[0];
                
                // Get appointments for current day
                const snapshot = await db.collection('appointments')
                    .where('date', '==', currentDateStr)
                    .get();
                
                const dayAppointments = [];
                
                for (const doc of snapshot.docs) {
                    const appointment = { id: doc.id, ...doc.data() };
                    
                    // Get client and service names
                    try {
                        const [clientDoc, serviceDoc] = await Promise.all([
                            db.collection('clients').doc(appointment.clientId).get(),
                            db.collection('services').doc(appointment.serviceId).get()
                        ]);
                        
                        appointment.clientName = clientDoc.exists ? clientDoc.data().name : 'Cliente n√£o encontrado';
                        appointment.serviceName = serviceDoc.exists ? serviceDoc.data().name : 'Servi√ßo n√£o encontrado';
                        appointment.serviceDuration = serviceDoc.exists ? serviceDoc.data().duration : 30;
                    } catch (error) {
                        console.error('Error loading appointment details:', error);
                        appointment.clientName = 'Cliente n√£o encontrado';
                        appointment.serviceName = 'Servi√ßo n√£o encontrado';
                        appointment.serviceDuration = 30;
                    }
                    
                    dayAppointments.push(appointment);
                }
                
                // Sort appointments by time
                dayAppointments.sort((a, b) => a.time.localeCompare(b.time));
                
                // Create daily timeline view
                const dayNames = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
                const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const dayName = dayNames[currentDate.getDay()];
                const isToday = currentDate.toDateString() === today.toDateString();
                
                let html = `
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900">
                                    ${dayName}, ${currentDate.getDate()} de ${monthNames[currentDate.getMonth()]}
                                    ${isToday ? '<span class="text-blue-600 text-lg ml-2">‚Ä¢ Hoje</span>' : ''}
                                </h3>
                                <p class="text-gray-500 mt-1">${currentDate.getFullYear()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="previousDay()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                    Anterior
                                </button>
                                <button onclick="goToToday()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Hoje
                                </button>
                                <button onclick="nextDay()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                                    Pr√≥ximo
                                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Daily Timeline -->
                        <div class="bg-white border rounded-lg overflow-hidden">
                `;
                
                // Generate time slots (8:00 to 20:00)
                for (let hour = 8; hour <= 20; hour++) {
                    const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
                    const nextHour = hour + 1;
                    const nextTimeSlot = `${nextHour.toString().padStart(2, '0')}:00`;
                    
                    // Find appointments for this time slot
                    const slotAppointments = dayAppointments.filter(apt => {
                        const aptHour = parseInt(apt.time.split(':')[0]);
                        return aptHour === hour;
                    });
                    
                    const isCurrentHour = isToday && new Date().getHours() === hour;
                    const hourClass = isCurrentHour ? 'bg-blue-50 border-l-4 border-blue-500' : '';
                    
                    html += `
                        <div class="border-b border-gray-100 hover:bg-gray-50 ${hourClass}">
                            <div class="flex">
                                <!-- Time Column -->
                                <div class="w-20 p-4 bg-gray-50 border-r border-gray-200 text-center">
                                    <div class="text-sm font-medium text-gray-900">${timeSlot}</div>
                                    <div class="text-xs text-gray-500">${nextTimeSlot}</div>
                                    ${isCurrentHour ? '<div class="w-2 h-2 bg-blue-500 rounded-full mx-auto mt-1"></div>' : ''}
                                </div>
                                
                                <!-- Appointments Column -->
                                <div class="flex-1 p-4 min-h-[80px] relative">
                    `;
                    
                    if (slotAppointments.length === 0) {
                        html += `
                            <div class="flex items-center justify-center h-full opacity-0 hover:opacity-100 transition-opacity">
                                <button onclick="createAppointmentAtTime('${currentDateStr}', '${timeSlot}')" 
                                        class="px-4 py-2 text-sm text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg border-2 border-dashed border-gray-200 hover:border-blue-300 transition-colors">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Agendar hor√°rio
                                </button>
                            </div>
                        `;
                    } else {
                        slotAppointments.forEach(appointment => {
                            const statusColors = {
                                'agendado': 'bg-blue-100 border-blue-300 text-blue-800',
                                'conclu√≠do': 'bg-green-100 border-green-300 text-green-800',
                                'cancelado': 'bg-red-100 border-red-300 text-red-800'
                            };
                            
                            const statusIcons = {
                                'agendado': 'üìÖ',
                                'conclu√≠do': '‚úÖ',
                                'cancelado': '‚ùå'
                            };
                            
                            const colorClass = statusColors[appointment.status] || 'bg-gray-100 border-gray-300 text-gray-800';
                            const icon = statusIcons[appointment.status] || 'üìÖ';
                            const duration = appointment.serviceDuration || 30;
                            
                            html += `
                                <div class="appointment-card ${colorClass} border-l-4 rounded-r-lg p-4 mb-2 cursor-pointer hover:shadow-md transition-shadow"
                                     onclick="viewAppointment('${appointment.id}', ${JSON.stringify(appointment).replace(/"/g, '&quot;')})">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-lg">${icon}</span>
                                            <div>
                                                <div class="font-semibold text-gray-900">${appointment.clientName}</div>
                                                <div class="text-sm text-gray-600">${appointment.serviceName}</div>
                                                <div class="text-xs text-gray-500 mt-1">
                                                    ${appointment.time} ‚Ä¢ ${duration} min ‚Ä¢ ${formatCurrency(appointment.totalValue || 0)}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-medium capitalize">${appointment.status}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                    
                    <!-- Daily Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <div class="p-2 bg-blue-100 rounded-lg">
                                    <span class="text-blue-600">üìÖ</span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-blue-600">Agendados</p>
                                    <p class="text-lg font-bold text-blue-800">${dayAppointments.filter(a => a.status === 'agendado').length}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <div class="p-2 bg-green-100 rounded-lg">
                                    <span class="text-green-600">‚úÖ</span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-green-600">Conclu√≠dos</p>
                                    <p class="text-lg font-bold text-green-800">${dayAppointments.filter(a => a.status === 'conclu√≠do').length}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <div class="p-2 bg-red-100 rounded-lg">
                                    <span class="text-red-600">‚ùå</span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-red-600">Cancelados</p>
                                    <p class="text-lg font-bold text-red-800">${dayAppointments.filter(a => a.status === 'cancelado').length}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <div class="p-2 bg-purple-100 rounded-lg">
                                    <span class="text-purple-600">üí∞</span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-purple-600">Receita do Dia</p>
                                    <p class="text-lg font-bold text-purple-800">${formatCurrency(dayAppointments.filter(a => a.status === 'conclu√≠do').reduce((sum, a) => sum + (a.totalValue || 0), 0))}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (dayAppointments.length === 0) {
                    html = `
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900">
                                        ${dayName}, ${currentDate.getDate()} de ${monthNames[currentDate.getMonth()]}
                                        ${isToday ? '<span class="text-blue-600 text-lg ml-2">‚Ä¢ Hoje</span>' : ''}
                                    </h3>
                                    <p class="text-gray-500 mt-1">${currentDate.getFullYear()}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="previousDay()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                        Anterior
                                    </button>
                                    <button onclick="goToToday()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Hoje
                                    </button>
                                    <button onclick="nextDay()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                                        Pr√≥ximo
                                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üìÖ</span>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum agendamento para ${isToday ? 'hoje' : 'este dia'}</h3>
                            <p class="text-gray-500 mb-6">Que tal criar um novo agendamento?</p>
                            <button onclick="createAppointment('${currentDateStr}')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                Criar Agendamento
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading appointments:', error);
                console.error('Error details:', error.message);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 mb-2">Erro ao carregar agendamentos</p>
                        <p class="text-sm text-gray-500">${error.message}</p>
                        <button onclick="loadAppointments()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        async function loadClients() {
            const container = document.getElementById('clients-list');
            showLoading(container);
            
            try {
                const snapshot = await db.collection('clients').orderBy('name').get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">Nenhum cliente encontrado</p>
                            <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="createClient()">
                                Cadastrar Primeiro Cliente
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                
                snapshot.forEach(doc => {
                    const client = doc.data();
                    html += `
                        <div class="bg-white p-6 rounded-lg border shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-medium">${client.name.charAt(0).toUpperCase()}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900">${client.name}</h3>
                                    <p class="text-sm text-gray-500">${client.phone || 'Sem telefone'}</p>
                                </div>
                            </div>
                            <div class="mt-4 space-y-2">
                                <p class="text-sm text-gray-600"><strong>Email:</strong> ${client.email || 'N√£o informado'}</p>
                                <p class="text-sm text-gray-600"><strong>Cadastrado:</strong> ${client.createdAt ? formatDate(client.createdAt.toDate()) : 'Data n√£o dispon√≠vel'}</p>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading clients:', error);
                container.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Erro ao carregar clientes</p></div>';
            }
        }

        async function loadServices() {
            const container = document.getElementById('services-list');
            showLoading(container);
            
            try {
                const snapshot = await db.collection('services').orderBy('name').get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">Nenhum servi√ßo encontrado</p>
                            <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="createService()">
                                Cadastrar Primeiro Servi√ßo
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                
                snapshot.forEach(doc => {
                    const service = doc.data();
                    
                    // Check if service has weekly prices
                    let priceDisplay = '';
                    if (service.weeklyPrices) {
                        const prices = service.weeklyPrices;
                        const minPrice = Math.min(...Object.values(prices));
                        const maxPrice = Math.max(...Object.values(prices));
                        
                        if (minPrice === maxPrice) {
                            priceDisplay = formatCurrency(minPrice);
                        } else {
                            priceDisplay = `${formatCurrency(minPrice)} - ${formatCurrency(maxPrice)}`;
                        }
                    } else {
                        priceDisplay = formatCurrency(service.price);
                    }
                    
                    // Generate weekly price breakdown if available
                    let weeklyPriceInfo = '';
                    if (service.weeklyPrices) {
                        const dayNames = {
                            monday: 'Seg',
                            tuesday: 'Ter', 
                            wednesday: 'Qua',
                            thursday: 'Qui',
                            friday: 'Sex',
                            saturday: 'S√°b',
                            sunday: 'Dom'
                        };
                        
                        weeklyPriceInfo = '<div class="mt-3 pt-3 border-t"><div class="text-xs text-gray-500 mb-2">Pre√ßos por dia:</div><div class="grid grid-cols-7 gap-1 text-xs">';
                        
                        Object.entries(service.weeklyPrices).forEach(([day, price]) => {
                            const isWeekend = day === 'saturday' || day === 'sunday';
                            const colorClass = isWeekend ? 'text-blue-600 font-medium' : 'text-gray-600';
                            weeklyPriceInfo += `
                                <div class="text-center">
                                    <div class="${colorClass}">${dayNames[day]}</div>
                                    <div class="font-medium">R$ ${price.toFixed(0)}</div>
                                </div>
                            `;
                        });
                        
                        weeklyPriceInfo += '</div></div>';
                    }
                    
                    html += `
                        <div class="bg-white p-6 rounded-lg border shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-medium text-gray-900">${service.name}</h3>
                                <div class="text-right">
                                    <span class="text-2xl font-bold text-blue-600">${priceDisplay}</span>
                                    ${service.weeklyPrices ? '<div class="text-xs text-gray-500">pre√ßos vari√°veis</div>' : ''}
                                </div>
                            </div>
                            <div class="space-y-2 mb-4">
                                <p class="text-sm text-gray-600"><strong>Dura√ß√£o:</strong> ${service.duration} minutos</p>
                                <p class="text-sm text-gray-600"><strong>Descri√ß√£o:</strong> ${service.description || 'Sem descri√ß√£o'}</p>
                            </div>
                            ${weeklyPriceInfo}
                            <div class="flex space-x-2 mt-4">
                                <button onclick="editService('${doc.id}', ${JSON.stringify(service).replace(/"/g, '&quot;')})" 
                                        class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                                    Editar
                                </button>
                                <button onclick="deleteService('${doc.id}', '${service.name}')" 
                                        class="px-3 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading services:', error);
                container.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Erro ao carregar servi√ßos</p></div>';
            }
        }

        async function loadProducts() {
            const container = document.getElementById('products-list');
            showLoading(container);
            
            try {
                const snapshot = await db.collection('products').orderBy('name').get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">Nenhum produto encontrado</p>
                            <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="createProduct()">
                                Cadastrar Primeiro Produto
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const stockStatus = product.stock > 10 ? 'Em estoque' : product.stock > 0 ? 'Estoque baixo' : 'Sem estoque';
                    const stockColor = product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-yellow-600' : 'text-red-600';
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${product.name}</div>
                                <div class="text-sm text-gray-500">${product.description || 'Sem descri√ß√£o'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.category || 'Sem categoria'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(product.price)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.stock || 0} unidades</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${stockColor}">${stockStatus}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button onclick="editProduct('${doc.id}', ${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                            class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        Editar
                                    </button>
                                    <button onclick="deleteProduct('${doc.id}', '${product.name}')" 
                                            class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                        Excluir
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Erro ao carregar produtos</p></div>';
            }
        }

        async function loadCashier() {
            const container = document.getElementById('cashier-content');
            showLoading(container);
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const cashierDoc = await db.collection('cashier').doc(today).get();
                
                if (!cashierDoc.exists || !cashierDoc.data().isOpen) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="bg-gray-50 rounded-lg p-8 max-w-md mx-auto">
                                <div class="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Caixa Fechado</h3>
                                <p class="text-gray-500 mb-6">Para come√ßar as vendas, abra o caixa informando o valor inicial</p>
                                <button class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium" onclick="openCashierModal()">
                                    Abrir Caixa
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const cashierData = cashierDoc.data();
                const movements = cashierData.movements || [];
                const sales = cashierData.sales || [];
                
                let totalIn = cashierData.initialAmount || 0;
                let totalOut = 0;
                let totalSales = 0;
                let totalWithdrawals = 0;
                
                movements.forEach(movement => {
                    if (movement.type === 'entrada') {
                        totalIn += movement.amount;
                    } else if (movement.type === 'saida') {
                        totalOut += movement.amount;
                    } else if (movement.type === 'retirada') {
                        totalWithdrawals += movement.amount;
                    }
                });
                
                sales.forEach(sale => {
                    totalSales += sale.total;
                });
                
                const currentBalance = totalIn + totalSales - totalOut - totalWithdrawals;
                
                let html = `
                    <!-- Header com Status do Caixa -->
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold">Caixa Aberto</h3>
                                <p class="text-blue-100">Aberto √†s ${cashierData.openedAt ? new Date(cashierData.openedAt.seconds * 1000).toLocaleTimeString('pt-BR') : 'N/A'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-blue-100 text-sm">Saldo Atual</p>
                                <p class="text-3xl font-bold">${formatCurrency(currentBalance)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Resumo Financeiro -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border shadow-sm">
                            <div class="flex items-center">
                                <div class="p-2 bg-blue-100 rounded-lg">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Valor Inicial</p>
                                    <p class="text-lg font-bold text-gray-900">${formatCurrency(cashierData.initialAmount || 0)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg border shadow-sm">
                            <div class="flex items-center">
                                <div class="p-2 bg-green-100 rounded-lg">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Vendas</p>
                                    <p class="text-lg font-bold text-green-600">${formatCurrency(totalSales)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg border shadow-sm">
                            <div class="flex items-center">
                                <div class="p-2 bg-red-100 rounded-lg">
                                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Retiradas</p>
                                    <p class="text-lg font-bold text-red-600">${formatCurrency(totalWithdrawals)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg border shadow-sm">
                            <div class="flex items-center">
                                <div class="p-2 bg-purple-100 rounded-lg">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Vendas Hoje</p>
                                    <p class="text-lg font-bold text-purple-600">${sales.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema de Vendas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Painel de Vendas -->
                        <div class="bg-white rounded-lg border p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Nova Venda</h3>
                            
                            <!-- Busca de Produtos/Servi√ßos -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Produto/Servi√ßo</label>
                                <div class="relative">
                                    <input type="text" id="search-items" placeholder="Digite para buscar..." 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                                </div>
                            </div>
                            
                            <!-- Carrinho de Compras -->
                            <div class="mb-4">
                                <h4 class="text-md font-medium text-gray-900 mb-2">Itens da Venda</h4>
                                <div id="cart-items" class="space-y-2 mb-4 min-h-[100px] max-h-60 overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-8">Nenhum item adicionado</p>
                                </div>
                                <div class="border-t pt-3">
                                    <div class="flex justify-between items-center text-lg font-bold">
                                        <span>Total:</span>
                                        <span id="cart-total" class="text-green-600">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- M√©todo de Pagamento -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">M√©todo de Pagamento</label>
                                <select id="payment-method" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Selecione o m√©todo</option>
                                    <option value="dinheiro">üíµ Dinheiro</option>
                                    <option value="cartao">üí≥ Cart√£o</option>
                                    <option value="pix">üì± PIX</option>
                                </select>
                            </div>
                            
                            <!-- Bot√µes de A√ß√£o -->
                            <div class="flex space-x-3">
                                <button id="clear-cart" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    Limpar
                                </button>
                                <button id="complete-sale" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Finalizar Venda
                                </button>
                            </div>
                        </div>
                        
                        <!-- A√ß√µes do Caixa -->
                        <div class="bg-white rounded-lg border p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">A√ß√µes do Caixa</h3>
                            <div class="space-y-3">
                                <button onclick="addCashMovement('entrada')" 
                                        class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Adicionar Entrada
                                </button>
                                <button onclick="addCashMovement('saida')" 
                                        class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                    Adicionar Sa√≠da
                                </button>
                                <button onclick="addWithdrawal()" 
                                        class="w-full px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    Fazer Retirada
                                </button>
                                <div class="border-t pt-3">
                                    <button onclick="closeCashierModal()" 
                                            class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900 flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                        Fechar Caixa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hist√≥rico de Movimenta√ß√µes -->
                    <div class="bg-white rounded-lg border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Movimenta√ß√µes do Dia</h3>
                `;
                
                const allMovements = [...movements, ...sales.map(sale => {
                    const paymentIcons = {
                        'dinheiro': 'üíµ',
                        'cartao': 'üí≥',
                        'pix': 'üì±'
                    };
                    const paymentIcon = paymentIcons[sale.paymentMethod] || 'üí∞';
                    
                    return {
                        type: 'venda',
                        description: `${paymentIcon} Venda #${sale.id} - ${sale.items.length} item(s) - ${sale.userName || 'Usu√°rio'}`,
                        amount: sale.total,
                        timestamp: sale.timestamp,
                        paymentMethod: sale.paymentMethod,
                        commission: sale.totalCommission || 0,
                        userId: sale.userId
                    };
                })].sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp ? b.timestamp.seconds : 0;
                    return timeB - timeA;
                });
                
                if (allMovements.length === 0) {
                    html += '<p class="text-gray-500 text-center py-8">Nenhuma movimenta√ß√£o registrada</p>';
                } else {
                    html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>';
                    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>';
                    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>';
                    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comiss√£o</th>';
                    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hor√°rio</th>';
                    html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                    
                    allMovements.forEach(movement => {
                        let typeColor = 'text-gray-600';
                        let typeText = movement.type;
                        let valueColor = 'text-gray-900';
                        
                        switch(movement.type) {
                            case 'entrada':
                                typeColor = 'text-green-600';
                                typeText = 'Entrada';
                                valueColor = 'text-green-600';
                                break;
                            case 'saida':
                                typeColor = 'text-red-600';
                                typeText = 'Sa√≠da';
                                valueColor = 'text-red-600';
                                break;
                            case 'retirada':
                                typeColor = 'text-orange-600';
                                typeText = 'Retirada';
                                valueColor = 'text-orange-600';
                                break;
                            case 'venda':
                                typeColor = 'text-blue-600';
                                typeText = 'Venda';
                                valueColor = 'text-blue-600';
                                break;
                        }
                        
                        // Show commission only for sales and only if it's the current user's sale
                        let commissionDisplay = '-';
                        if (movement.type === 'venda' && movement.userId === currentUser.id && movement.commission > 0) {
                            commissionDisplay = `<span class="text-purple-600 font-medium">${formatCurrency(movement.commission)}</span>`;
                        } else if (movement.type === 'venda' && movement.commission > 0) {
                            commissionDisplay = `<span class="text-gray-400">${formatCurrency(movement.commission)}</span>`;
                        }
                        
                        html += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 ${typeColor}">${typeText}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${movement.description}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${valueColor}">${formatCurrency(movement.amount)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${commissionDisplay}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${movement.timestamp ? new Date(movement.timestamp.seconds * 1000).toLocaleTimeString('pt-BR') : 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
                
                // Initialize search functionality
                initializeCashierSearch();
                
            } catch (error) {
                console.error('Error loading cashier:', error);
                container.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Erro ao carregar informa√ß√µes do caixa</p></div>';
            }
        }

        
async function loadReports() {
    const container = document.getElementById('reports-content');
    container.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Relat√≥rios Financeiros</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data In√≠cio</label>
                    <input type="date" id="report-start" class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                    <input type="date" id="report-end" class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Relat√≥rio</label>
                    <select id="report-type" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="general">Geral</option>
                        <option value="user">Por Usu√°rio</option>
                    </select>
                </div>
            </div>

            <div id="user-filter-container" class="hidden mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Selecionar Usu√°rio</label>
                <select id="user-filter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                    <option value="all">Todos os Usu√°rios</option>
                </select>
            </div>

            <div class="flex space-x-3 mb-6">
                <button id="generate-report" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Gerar Relat√≥rio</button>
                <button id="download-pdf" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden">Baixar PDF</button>
            </div>

            <div id="report-results">
                <p class="text-gray-500">Selecione um per√≠odo e clique em "Gerar Relat√≥rio".</p>
            </div>
        </div>
    `;

    // References to DOM elements
    const userFilterSelect = document.getElementById('user-filter');
    const userFilterContainer = document.getElementById('user-filter-container');
    const reportTypeSelect = document.getElementById('report-type');
    const generateBtn = document.getElementById('generate-report');
    const downloadBtn = document.getElementById('download-pdf');
    const reportResults = document.getElementById('report-results');

    // Helper to parse date strings (YYYY-MM-DD)
    function dateInRange(docDateStr, startStr, endStr) {
        try {
            // docDateStr is expected to be the document id in format YYYY-MM-DD
            if (!docDateStr) return false;
            if (!startStr || !endStr) return false;
            return docDateStr >= startStr && docDateStr <= endStr;
        } catch (e) {
            return false;
        }
    }

    // Toggle user filter when "Por Usu√°rio" selected
    reportTypeSelect.addEventListener('change', async () => {
        if (reportTypeSelect.value === 'user') {
            userFilterContainer.classList.remove('hidden');
            // Load users into select if not loaded yet
            if (userFilterSelect.options.length <= 1) {
                try {
                    const usersSnapshot = await db.collection('users').orderBy('name').get();
                    usersSnapshot.forEach(doc => {
                        const user = doc.data();
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.textContent = `${user.name} (${user.role || 'sem papel'})`;
                        userFilterSelect.appendChild(opt);
                    });
                } catch (err) {
                    console.error('Erro ao carregar usu√°rios para filtro:', err);
                }
            }
        } else {
            userFilterContainer.classList.add('hidden');
        }
    });

    // Generate report on button click
    generateBtn.addEventListener('click', async () => {
        const startDate = document.getElementById('report-start').value;
        const endDate = document.getElementById('report-end').value;
        const type = document.getElementById('report-type').value;
        const selectedUser = userFilterSelect.value;

        if (!startDate || !endDate) {
            showToast('Selecione as datas inicial e final', 'error');
            return;
        }

        // Ensure start <= end
        if (startDate > endDate) {
            showToast('Data in√≠cio n√£o pode ser maior que data fim', 'error');
            return;
        }

        reportResults.innerHTML = '<div class="flex justify-center py-6"><div class="loading-spinner"></div></div>';
        downloadBtn.classList.add('hidden');

        try {
            const snapshot = await db.collection('cashier').get();
            let totalRevenue = 0, totalServiceCommission = 0, totalProductCommission = 0, totalCommission = 0;
            const userTotals = {};

            snapshot.forEach(doc => {
                const date = doc.id;
                if (!dateInRange(date, startDate, endDate)) return;
                const data = doc.data();
                if (!data) return;
                const sales = data.sales || [];
                sales.forEach(sale => {
                    if (type === 'user' && selectedUser !== 'all' && sale.userId !== selectedUser) return;

                    const saleTotal = Number(sale.total || 0);
                    const serviceComm = Number(sale.serviceCommission || 0);
                    const productComm = Number(sale.productCommission || 0);
                    const totalComm = Number(sale.totalCommission || 0);

                    totalRevenue += saleTotal;
                    totalServiceCommission += serviceComm;
                    totalProductCommission += productComm;
                    totalCommission += totalComm;

                    if (!userTotals[sale.userId]) {
                        userTotals[sale.userId] = { total: 0, commission: 0 };
                    }
                    userTotals[sale.userId].total += saleTotal;
                    userTotals[sale.userId].commission += totalComm;
                });
            });

            let html = '';

            if (type === 'general') {
                html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-700">Total de Vendas</p>
                            <p class="text-xl font-bold text-blue-900">${formatCurrency(totalRevenue)}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-700">Comiss√£o Servi√ßos</p>
                            <p class="text-xl font-bold text-green-900">${formatCurrency(totalServiceCommission)}</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm text-purple-700">Comiss√£o Produtos</p>
                            <p class="text-xl font-bold text-purple-900">${formatCurrency(totalProductCommission)}</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="text-sm text-orange-700">Comiss√£o Total</p>
                            <p class="text-xl font-bold text-orange-900">${formatCurrency(totalCommission)}</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Resumo por dia</h3>
                        <div class="overflow-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Data</th>
                                        <th class="px-4 py-2 text-right text-sm font-medium text-gray-700">Total Vendas</th>
                                        <th class="px-4 py-2 text-right text-sm font-medium text-gray-700">Comiss√£o Total</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-summary-body" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Build daily summary table
                let dailyRows = '';
                snapshot.forEach(doc => {
                    const date = doc.id;
                    if (!dateInRange(date, startDate, endDate)) return;
                    const data = doc.data();
                    const sales = data.sales || [];
                    let dayTotal = 0;
                    let dayCommission = 0;
                    sales.forEach(sale => {
                        dayTotal += Number(sale.total || 0);
                        dayCommission += Number(sale.totalCommission || 0);
                    });
                    if (dayTotal === 0 && dayCommission === 0) return;
                    dailyRows += `
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-700">${date}</td>
                            <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(dayTotal)}</td>
                            <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(dayCommission)}</td>
                        </tr>
                    `;
                });

                // Insert daily rows (safe fallback)
                html = html.replace('<tbody id="daily-summary-body" class="bg-white divide-y divide-gray-100"></tbody>',
                                    `<tbody id="daily-summary-body" class="bg-white divide-y divide-gray-100">${dailyRows}</tbody>`);
            } else {
                // User report
                // Map user IDs to names (fetch users once)
                const usersSnapshot = await db.collection('users').get();
                const userMap = {};
                usersSnapshot.forEach(doc => userMap[doc.id] = doc.data().name || ('Usu√°rio ' + doc.id));

                html = `
                    <div class="overflow-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Usu√°rio</th>
                                    <th class="px-4 py-2 text-right text-sm font-medium text-gray-700">Total Vendido</th>
                                    <th class="px-4 py-2 text-right text-sm font-medium text-gray-700">Comiss√£o Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                `;

                // If userTotals empty, show a friendly message
                if (Object.keys(userTotals).length === 0) {
                    html += `
                        <tr><td class="px-4 py-4 text-sm text-gray-700" colspan="3">Nenhuma venda encontrada para o per√≠odo/usu√°rio selecionado.</td></tr>
                    `;
                } else {
                    Object.keys(userTotals).forEach(uid => {
                        const name = userMap[uid] || ('Usu√°rio ' + uid);
                        html += `
                            <tr>
                                <td class="px-4 py-2 text-sm text-gray-700">${name}</td>
                                <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(userTotals[uid].total)}</td>
                                <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(userTotals[uid].commission)}</td>
                            </tr>
                        `;
                    });
                }

                html += `</tbody></table></div>`;
            }

            reportResults.innerHTML = html;
            downloadBtn.classList.remove('hidden');

            // Configure PDF export (simple textual export)
            downloadBtn.onclick = async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                    const leftMargin = 40;
                    let y = 40;
                    doc.setFontSize(14);
                    doc.text("Relat√≥rio Financeiro - Barbearia Pedro's", leftMargin, y);
                    y += 20;
                    doc.setFontSize(11);
                    doc.text(`Per√≠odo: ${startDate} at√© ${endDate}`, leftMargin, y);
                    y += 20;

                    // For general summary, add totals
                    if (type === 'general') {
                        doc.text(`Total de Vendas: ${formatCurrency(totalRevenue)}`, leftMargin, y); y += 16;
                        doc.text(`Comiss√£o Servi√ßos: ${formatCurrency(totalServiceCommission)}`, leftMargin, y); y += 16;
                        doc.text(`Comiss√£o Produtos: ${formatCurrency(totalProductCommission)}`, leftMargin, y); y += 16;
                        doc.text(`Comiss√£o Total: ${formatCurrency(totalCommission)}`, leftMargin, y); y += 24;

                        // Add daily rows (limited to avoid overflow)
                        doc.setFontSize(10);
                        doc.text("Resumo Di√°rio:", leftMargin, y); y += 14;
                        snapshot.forEach(docSnap => {
                            const date = docSnap.id;
                            if (!dateInRange(date, startDate, endDate)) return;
                            const data = docSnap.data();
                            const sales = data.sales || [];
                            let dayTotal = 0;
                            let dayCommission = 0;
                            sales.forEach(sale => {
                                dayTotal += Number(sale.total || 0);
                                dayCommission += Number(sale.totalCommission || 0);
                            });
                            if (dayTotal === 0 && dayCommission === 0) return;
                            const line = `${date} ‚Äî Total: ${formatCurrency(dayTotal)} ‚Äî Comiss√£o: ${formatCurrency(dayCommission)}`;
                            doc.text(line, leftMargin, y); y += 12;
                            if (y > 750) { doc.addPage(); y = 40; }
                        });
                    } else {
                        // For user report, list users
                        doc.setFontSize(10);
                        doc.text("Relat√≥rio por usu√°rio:", leftMargin, y); y += 14;
                        const usersSnapshot2 = await db.collection('users').get();
                        const userMap2 = {};
                        usersSnapshot2.forEach(d => userMap2[d.id] = d.data().name || ('Usu√°rio ' + d.id));
                        Object.keys(userTotals).forEach(uid => {
                            const name = userMap2[uid] || ('Usu√°rio ' + uid);
                            const line = `${name} ‚Äî Total: ${formatCurrency(userTotals[uid].total)} ‚Äî Comiss√£o: ${formatCurrency(userTotals[uid].commission)}`;
                            doc.text(line, leftMargin, y); y += 12;
                            if (y > 750) { doc.addPage(); y = 40; }
                        });
                    }

                    doc.save(`relatorio-financeiro_${startDate}_ate_${endDate}.pdf`);
                } catch (err) {
                    console.error('Erro ao gerar PDF:', err);
                    showToast('Erro ao gerar PDF', 'error');
                }
            };

        } catch (error) {
            console.error('Erro ao gerar relat√≥rio:', error);
            reportResults.innerHTML = `<p class="text-red-500">Erro ao gerar relat√≥rio</p>`;
        }
    });
}


        async function loadUsers() {
            const container = document.getElementById('users-list');
            showLoading(container);
            
            try {
                const snapshot = await db.collection('users').orderBy('name').get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">Nenhum usu√°rio encontrado</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const roleColors = {
                        'admin': 'bg-purple-100 text-purple-800',
                        'barbeiro': 'bg-blue-100 text-blue-800'
                    };
                    
                    const statusColors = {
                        'ativo': 'bg-green-100 text-green-800',
                        'inativo': 'bg-red-100 text-red-800'
                    };
                    
                    html += `
                        <div class="bg-white p-6 rounded-lg border shadow-sm">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-12 h-12 bg-gray-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-medium">${user.name.charAt(0).toUpperCase()}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900">${user.name}</h3>
                                    <p class="text-sm text-gray-500">${user.email}</p>
                                </div>
                            </div>
                            <div class="space-y-2 mb-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Fun√ß√£o:</span>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${roleColors[user.role] || 'bg-gray-100 text-gray-800'}">
                                        ${user.role === 'admin' ? 'Administrador' : 'Barbeiro'}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Status:</span>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[user.status] || 'bg-gray-100 text-gray-800'}">
                                        ${user.status || 'ativo'}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Comiss√£o Servi√ßos:</span>
                                    <span class="text-sm font-medium">${user.serviceCommissionPercentage || 0}%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Comiss√£o Produtos:</span>
                                    <span class="text-sm font-medium">${user.productCommissionPercentage || 0}%</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editUser('${doc.id}', ${JSON.stringify(user).replace(/"/g, '&quot;')})" 
                                        class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                                    Editar
                                </button>
                                <button onclick="deleteUser('${doc.id}', '${user.name}')" 
                                        class="px-3 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Erro ao carregar usu√°rios</p></div>';
            }
        }

        async function loadSettings() {
            const container = document.getElementById('settings-content');
            showLoading(container);
            
            try {
                let html = `
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Configura√ß√µes da Barbearia</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Barbearia</label>
                                    <input type="text" id="business-name-setting" value="Barbearia Pedro's" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Hor√°rio de Funcionamento</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input type="time" value="08:00" class="px-3 py-2 border border-gray-300 rounded-md">
                                        <input type="time" value="18:00" class="px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                                    <input type="tel" placeholder="(11) 99999-9999" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                    <textarea rows="3" placeholder="Digite o endere√ßo completo" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Salvar Configura√ß√µes
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg border">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Backup e Dados</h3>
                            <div class="space-y-4">
                                <p class="text-sm text-gray-600">Gerencie os dados do sistema</p>
                                <div class="flex space-x-4">
                                    <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" onclick="createSampleData()">
                                        Criar Dados de Exemplo
                                    </button>
                                    <button class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                                        Exportar Dados
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading settings:', error);
                container.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Erro ao carregar configura√ß√µes</p></div>';
            }
        }

        // Sample Data Creation Functions
        async function createSampleData() {
            if (!confirm('Isso criar√° dados de exemplo no sistema. Continuar?')) return;
            
            try {
                showToast('Criando dados de exemplo...', 'success');
                
                // Create sample services
                const services = [
                    { name: 'Corte Masculino', price: 25, duration: 30, description: 'Corte tradicional masculino' },
                    { name: 'Barba', price: 15, duration: 20, description: 'Aparar e modelar barba' },
                    { name: 'Corte + Barba', price: 35, duration: 45, description: 'Pacote completo' },
                    { name: 'Sobrancelha', price: 10, duration: 15, description: 'Design de sobrancelha' }
                ];
                
                for (const service of services) {
                    await db.collection('services').add({
                        ...service,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id
                    });
                }
                
                // Create sample products
                const products = [
                    { name: 'Pomada Modeladora', price: 25, stock: 15, category: 'Cabelo', description: 'Pomada para modelar cabelo' },
                    { name: '√ìleo para Barba', price: 30, stock: 8, category: 'Barba', description: '√ìleo hidratante para barba' },
                    { name: 'Shampoo Masculino', price: 20, stock: 12, category: 'Cabelo', description: 'Shampoo espec√≠fico para homens' },
                    { name: 'Cera Modeladora', price: 22, stock: 10, category: 'Cabelo', description: 'Cera para fixa√ß√£o' }
                ];
                
                for (const product of products) {
                    await db.collection('products').add({
                        ...product,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id
                    });
                }
                
                // Create sample clients
                const clients = [
                    { name: 'Jo√£o Silva', phone: '(11) 99999-1111', email: 'joao@email.com' },
                    { name: 'Pedro Santos', phone: '(11) 99999-2222', email: 'pedro@email.com' },
                    { name: 'Carlos Oliveira', phone: '(11) 99999-3333', email: 'carlos@email.com' },
                    { name: 'Roberto Lima', phone: '(11) 99999-4444', email: 'roberto@email.com' }
                ];
                
                const clientIds = [];
                for (const client of clients) {
                    const docRef = await db.collection('clients').add({
                        ...client,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id
                    });
                    clientIds.push(docRef.id);
                }
                
                // Get service IDs for appointments
                const servicesSnapshot = await db.collection('services').limit(4).get();
                const serviceIds = servicesSnapshot.docs.map(doc => doc.id);
                
                // Create sample appointments
                const today = new Date();
                const appointments = [
                    { 
                        clientId: clientIds[0], 
                        serviceId: serviceIds[0], 
                        date: today.toISOString().split('T')[0], 
                        time: '09:00', 
                        status: 'agendado', 
                        totalValue: 25 
                    },
                    { 
                        clientId: clientIds[1], 
                        serviceId: serviceIds[1], 
                        date: today.toISOString().split('T')[0], 
                        time: '10:30', 
                        status: 'conclu√≠do', 
                        totalValue: 15 
                    },
                    { 
                        clientId: clientIds[2], 
                        serviceId: serviceIds[2], 
                        date: today.toISOString().split('T')[0], 
                        time: '14:00', 
                        status: 'agendado', 
                        totalValue: 35 
                    }
                ];
                
                for (const appointment of appointments) {
                    await db.collection('appointments').add({
                        ...appointment,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id,
                        barberId: currentUser.id
                    });
                }
                
                showToast('Dados de exemplo criados com sucesso!', 'success');
                
                // Reload current section
                loadSectionContent(currentSection);
                
            } catch (error) {
                console.error('Error creating sample data:', error);
                showToast('Erro ao criar dados de exemplo', 'error');
            }
        }

        function createClient() {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Novo Cliente</h3>
                        <form id="create-client-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                                    <input type="text" id="create-client-name" required
                                           placeholder="Digite o nome completo do cliente"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                    <input type="tel" id="create-client-phone" 
                                           placeholder="(11) 99999-9999"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="create-client-email" 
                                           placeholder="cliente@email.com"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento</label>
                                    <input type="date" id="create-client-birthdate"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                                    <textarea id="create-client-notes" rows="3" 
                                              placeholder="Prefer√™ncias, alergias, observa√ß√µes especiais..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Cadastrar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('create-client-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const clientData = {
                    name: document.getElementById('create-client-name').value,
                    phone: document.getElementById('create-client-phone').value,
                    email: document.getElementById('create-client-email').value,
                    birthdate: document.getElementById('create-client-birthdate').value,
                    notes: document.getElementById('create-client-notes').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.id
                };
                
                try {
                    await db.collection('clients').add(clientData);
                    showToast('Cliente cadastrado com sucesso!');
                    closeModal();
                    loadClients();
                } catch (error) {
                    console.error('Error creating client:', error);
                    showToast('Erro ao cadastrar cliente', 'error');
                }
            });
        }

        function createService() {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Novo Servi√ßo</h3>
                        <form id="create-service-form">
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Servi√ßo</label>
                                        <input type="text" id="create-service-name" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Dura√ß√£o (minutos)</label>
                                        <input type="number" id="create-service-duration" value="30" min="1" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                                    <textarea id="create-service-description" rows="2" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>

                                <div class="border-t pt-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-md font-medium text-gray-900">Pre√ßos por Dia da Semana</h4>
                                        <div class="flex items-center space-x-2">
                                            <input type="number" id="create-bulk-price" step="0.01" min="0" placeholder="Pre√ßo √∫nico"
                                                   class="px-3 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <button type="button" id="create-apply-bulk-price" 
                                                    class="px-3 py-1 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                                Aplicar a Todos
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="space-y-3">
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Segunda-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-monday" value="25" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Ter√ßa-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-tuesday" value="25" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Quarta-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-wednesday" value="25" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Quinta-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-thursday" value="25" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Sexta-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-friday" value="30" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700 text-blue-600">S√°bado</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-saturday" value="35" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700 text-red-600">Domingo</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="create-price-sunday" value="35" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 bg-red-50">
                                                </div>
                                            </div>
                                            <div class="pt-2 border-t">
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="font-medium text-gray-700">Pre√ßo M√©dio:</span>
                                                    <span id="create-average-price" class="font-bold text-green-600">R$ 0,00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Criar Servi√ßo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            // Function to calculate and update average price
            function updateCreateAveragePrice() {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                let total = 0;
                let count = 0;
                
                days.forEach(day => {
                    const input = document.getElementById(`create-price-${day}`);
                    if (input && input.value) {
                        total += parseFloat(input.value) || 0;
                        count++;
                    }
                });
                
                const average = count > 0 ? total / count : 0;
                document.getElementById('create-average-price').textContent = formatCurrency(average);
            }
            
            // Add event listeners for price inputs
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                const input = document.getElementById(`create-price-${day}`);
                if (input) {
                    input.addEventListener('input', updateCreateAveragePrice);
                }
            });
            
            // Bulk price application
            document.getElementById('create-apply-bulk-price').addEventListener('click', function() {
                const bulkPrice = document.getElementById('create-bulk-price').value;
                if (bulkPrice && parseFloat(bulkPrice) >= 0) {
                    days.forEach(day => {
                        const input = document.getElementById(`create-price-${day}`);
                        if (input) {
                            input.value = bulkPrice;
                        }
                    });
                    updateCreateAveragePrice();
                    showToast('Pre√ßo aplicado a todos os dias!');
                } else {
                    showToast('Digite um pre√ßo v√°lido', 'error');
                }
            });
            
            // Initial average calculation
            updateCreateAveragePrice();
            
            document.getElementById('create-service-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Collect weekly prices
                const weeklyPrices = {};
                days.forEach(day => {
                    const input = document.getElementById(`create-price-${day}`);
                    weeklyPrices[day] = parseFloat(input.value) || 0;
                });
                
                // Calculate average price for backward compatibility
                const averagePrice = Object.values(weeklyPrices).reduce((sum, price) => sum + price, 0) / 7;
                
                const serviceData = {
                    name: document.getElementById('create-service-name').value,
                    price: averagePrice, // Keep for backward compatibility
                    weeklyPrices: weeklyPrices, // New weekly pricing structure
                    duration: parseInt(document.getElementById('create-service-duration').value),
                    description: document.getElementById('create-service-description').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.id
                };
                
                try {
                    await db.collection('services').add(serviceData);
                    showToast('Servi√ßo criado com sucesso!');
                    closeModal();
                    loadServices();
                } catch (error) {
                    console.error('Error creating service:', error);
                    showToast('Erro ao criar servi√ßo', 'error');
                }
            });
        }

        function createProduct() {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Novo Produto</h3>
                        <form id="create-product-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                                    <input type="text" id="create-product-name" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo (R$)</label>
                                    <input type="number" id="create-product-price" step="0.01" min="0" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade em Estoque</label>
                                    <input type="number" id="create-product-stock" min="0" value="0" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                    <input type="text" id="create-product-category" placeholder="Ex: Cabelo, Barba, Cuidados"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                                    <textarea id="create-product-description" rows="3" placeholder="Descri√ß√£o do produto..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Criar Produto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('create-product-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const productData = {
                    name: document.getElementById('create-product-name').value,
                    price: parseFloat(document.getElementById('create-product-price').value),
                    stock: parseInt(document.getElementById('create-product-stock').value),
                    category: document.getElementById('create-product-category').value,
                    description: document.getElementById('create-product-description').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.id
                };
                
                try {
                    await db.collection('products').add(productData);
                    showToast('Produto criado com sucesso!');
                    closeModal();
                    loadProducts();
                } catch (error) {
                    console.error('Error creating product:', error);
                    showToast('Erro ao criar produto', 'error');
                }
            });
        }

        async function createAppointment(prefilledDate = null, prefilledTime = null) {
            try {
                // Get clients and services first
                const [clientsSnapshot, servicesSnapshot] = await Promise.all([
                    db.collection('clients').get(),
                    db.collection('services').get()
                ]);
                
                if (clientsSnapshot.empty) {
                    showToast('Cadastre pelo menos um cliente primeiro', 'error');
                    return;
                }
                
                if (servicesSnapshot.empty) {
                    showToast('Cadastre pelo menos um servi√ßo primeiro', 'error');
                    return;
                }
                
                // Build client options
                let clientOptions = '';
                clientsSnapshot.forEach(doc => {
                    const client = doc.data();
                    clientOptions += `<option value="${doc.id}">${client.name} - ${client.phone || 'Sem telefone'}</option>`;
                });
                
                // Build service options
                let serviceOptions = '';
                servicesSnapshot.forEach(doc => {
                    const service = doc.data();
                    const priceDisplay = service.weeklyPrices ? 
                        `${formatCurrency(Math.min(...Object.values(service.weeklyPrices)))} - ${formatCurrency(Math.max(...Object.values(service.weeklyPrices)))}` :
                        formatCurrency(service.price);
                    serviceOptions += `<option value="${doc.id}" data-price="${service.price}" data-duration="${service.duration}" data-weekly-prices='${JSON.stringify(service.weeklyPrices || {})}'>${service.name} - ${priceDisplay} (${service.duration}min)</option>`;
                });
                
                // Use prefilled values or current date/time
                const today = new Date();
                const defaultDate = prefilledDate || today.toISOString().split('T')[0];
                const defaultTime = prefilledTime || today.toTimeString().slice(0, 5);
                
                const modalHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Novo Agendamento</h3>
                            <form id="create-appointment-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                                        <select id="create-appointment-client" required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Selecione um cliente</option>
                                            ${clientOptions}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Servi√ßo</label>
                                        <select id="create-appointment-service" required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Selecione um servi√ßo</option>
                                            ${serviceOptions}
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                            <input type="date" id="create-appointment-date" value="${defaultDate}" required
                                                   min="${today.toISOString().split('T')[0]}"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Hor√°rio</label>
                                            <input type="time" id="create-appointment-time" value="${defaultTime}" required
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-blue-800 mb-2">Resumo do Agendamento</h4>
                                        <div class="space-y-1 text-sm text-blue-700">
                                            <div class="flex justify-between">
                                                <span>Dura√ß√£o:</span>
                                                <span id="appointment-duration">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Valor:</span>
                                                <span id="appointment-price">-</span>
                                            </div>
                                            <div class="flex justify-between font-medium">
                                                <span>Hor√°rio de t√©rmino:</span>
                                                <span id="appointment-end-time">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                                        <textarea id="create-appointment-notes" rows="3" 
                                                  placeholder="Observa√ß√µes especiais para este agendamento..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal()" 
                                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                        Cancelar
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Criar Agendamento
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.getElementById('modal-container').innerHTML = modalHtml;
                
                // Update appointment summary when service or date/time changes
                function updateAppointmentSummary() {
                    const serviceSelect = document.getElementById('create-appointment-service');
                    const dateInput = document.getElementById('create-appointment-date');
                    const timeInput = document.getElementById('create-appointment-time');
                    
                    if (serviceSelect.value && dateInput.value && timeInput.value) {
                        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                        const duration = parseInt(selectedOption.getAttribute('data-duration')) || 0;
                        const weeklyPrices = JSON.parse(selectedOption.getAttribute('data-weekly-prices') || '{}');
                        const basePrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                        
                        // Calculate price based on day of week if weekly prices exist
                        let price = basePrice;
                        if (Object.keys(weeklyPrices).length > 0) {
                            const selectedDate = new Date(dateInput.value);
                            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            const dayName = dayNames[selectedDate.getDay()];
                            price = weeklyPrices[dayName] || basePrice;
                        }
                        
                        // Calculate end time
                        const [hours, minutes] = timeInput.value.split(':').map(Number);
                        const startTime = new Date();
                        startTime.setHours(hours, minutes, 0, 0);
                        const endTime = new Date(startTime.getTime() + duration * 60000);
                        
                        document.getElementById('appointment-duration').textContent = `${duration} minutos`;
                        document.getElementById('appointment-price').textContent = formatCurrency(price);
                        document.getElementById('appointment-end-time').textContent = endTime.toTimeString().slice(0, 5);
                    } else {
                        document.getElementById('appointment-duration').textContent = '-';
                        document.getElementById('appointment-price').textContent = '-';
                        document.getElementById('appointment-end-time').textContent = '-';
                    }
                }
                
                // Add event listeners
                document.getElementById('create-appointment-service').addEventListener('change', updateAppointmentSummary);
                document.getElementById('create-appointment-date').addEventListener('change', updateAppointmentSummary);
                document.getElementById('create-appointment-time').addEventListener('change', updateAppointmentSummary);
                
                document.getElementById('create-appointment-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const clientId = document.getElementById('create-appointment-client').value;
                    const serviceId = document.getElementById('create-appointment-service').value;
                    const date = document.getElementById('create-appointment-date').value;
                    const time = document.getElementById('create-appointment-time').value;
                    const notes = document.getElementById('create-appointment-notes').value;
                    
                    // Get service data for price calculation
                    const serviceSelect = document.getElementById('create-appointment-service');
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    const weeklyPrices = JSON.parse(selectedOption.getAttribute('data-weekly-prices') || '{}');
                    const basePrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                    
                    // Calculate price based on day of week
                    let totalValue = basePrice;
                    if (Object.keys(weeklyPrices).length > 0) {
                        const selectedDate = new Date(date);
                        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        const dayName = dayNames[selectedDate.getDay()];
                        totalValue = weeklyPrices[dayName] || basePrice;
                    }
                    
                    const appointmentData = {
                        clientId: clientId,
                        serviceId: serviceId,
                        date: date,
                        time: time,
                        status: 'agendado',
                        totalValue: totalValue,
                        notes: notes,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.id,
                        barberId: currentUser.id
                    };
                    
                    try {
                        await db.collection('appointments').add(appointmentData);
                        showToast('Agendamento criado com sucesso!');
                        closeModal();
                        loadAppointments();
                        
                        // Reload dashboard if we're on it
                        if (currentSection === 'dashboard') {
                            loadDashboard();
                        }
                    } catch (error) {
                        console.error('Error creating appointment:', error);
                        showToast('Erro ao criar agendamento', 'error');
                    }
                });
                
            } catch (error) {
                console.error('Error loading data for appointment creation:', error);
                showToast('Erro ao carregar dados para agendamento', 'error');
            }
        }

        async function addCashMovement(type) {
            const description = prompt(`Descri√ß√£o da ${type}:`);
            if (!description) return;
            
            const amountStr = prompt('Valor (R$):');
            const amount = parseFloat(amountStr?.replace(',', '.') || '0');
            if (isNaN(amount) || amount <= 0) {
                showToast('Valor inv√°lido', 'error');
                return;
            }
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const cashierRef = db.collection('cashier').doc(today);
                
                await cashierRef.update({
                    movements: firebase.firestore.FieldValue.arrayUnion({
                        type,
                        description,
                        amount,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: currentUser.id
                    })
                });
                
                showToast(`${type === 'entrada' ? 'Entrada' : 'Sa√≠da'} registrada com sucesso!`);
                loadCashier();
                
            } catch (error) {
                console.error('Error adding cash movement:', error);
                showToast('Erro ao registrar movimenta√ß√£o', 'error');
            }
        }

        // Cashier Functions
        let currentCart = [];

        function openCashierModal() {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Abrir Caixa</h3>
                        <form id="open-cashier-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor Inicial do Caixa</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500">R$</span>
                                        <input type="number" id="initial-amount" step="0.01" min="0" required
                                               placeholder="0,00" 
                                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Digite o valor em dinheiro que est√° no caixa para iniciar</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes (opcional)</label>
                                    <textarea id="opening-notes" rows="2" placeholder="Ex: Troco, notas, moedas..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Abrir Caixa
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('open-cashier-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById('initial-amount').value);
                const notes = document.getElementById('opening-notes').value;
                
                if (isNaN(amount) || amount < 0) {
                    showToast('Valor inv√°lido', 'error');
                    return;
                }
                
                try {
                    const today = new Date().toISOString().split('T')[0];
                    await db.collection('cashier').doc(today).set({
                        date: today,
                        isOpen: true,
                        initialAmount: amount,
                        openingNotes: notes,
                        openedBy: currentUser.id,
                        openedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        movements: [],
                        sales: []
                    });
                    
                    showToast('Caixa aberto com sucesso!');
                    closeModal();
                    await checkCashierStatus();
                    if (currentSection === 'cashier') {
                        loadCashier();
                    }
                } catch (error) {
                    console.error('Error opening cashier:', error);
                    showToast('Erro ao abrir caixa', 'error');
                }
            });
        }

        async function closeCashierModal() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const cashierDoc = await db.collection('cashier').doc(today).get();
                
                if (!cashierDoc.exists) {
                    showToast('Caixa n√£o encontrado', 'error');
                    return;
                }
                
                const cashierData = cashierDoc.data();
                const movements = cashierData.movements || [];
                const sales = cashierData.sales || [];
                
                // Calculate totals for report
                let totalIn = cashierData.initialAmount || 0;
                let totalOut = 0;
                let totalSales = 0;
                let totalWithdrawals = 0;
                
                movements.forEach(movement => {
                    if (movement.type === 'entrada') {
                        totalIn += movement.amount;
                    } else if (movement.type === 'saida') {
                        totalOut += movement.amount;
                    } else if (movement.type === 'retirada') {
                        totalWithdrawals += movement.amount;
                    }
                });
                
                sales.forEach(sale => {
                    totalSales += sale.total;
                });
                
                const finalBalance = totalIn + totalSales - totalOut - totalWithdrawals;
                
                const modalHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                            <h3 class="text-xl font-bold text-gray-900 mb-6">Relat√≥rio de Fechamento do Caixa</h3>
                            
                            <!-- Resumo Financeiro -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <p class="text-sm text-blue-600 font-medium">Valor Inicial</p>
                                    <p class="text-lg font-bold text-blue-800">${formatCurrency(cashierData.initialAmount || 0)}</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <p class="text-sm text-green-600 font-medium">Vendas</p>
                                    <p class="text-lg font-bold text-green-800">${formatCurrency(totalSales)}</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg text-center">
                                    <p class="text-sm text-red-600 font-medium">Retiradas</p>
                                    <p class="text-lg font-bold text-red-800">${formatCurrency(totalWithdrawals)}</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg text-center">
                                    <p class="text-sm text-purple-600 font-medium">Saldo Final</p>
                                    <p class="text-xl font-bold text-purple-800">${formatCurrency(finalBalance)}</p>
                                </div>
                            </div>
                            
                            <!-- Detalhes das Vendas -->
                            <div class="mb-6">
                                <h4 class="text-lg font-medium text-gray-900 mb-3">Resumo de Vendas</h4>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <p class="text-2xl font-bold text-gray-900">${sales.length}</p>
                                            <p class="text-sm text-gray-600">Total de Vendas</p>
                                        </div>
                                        <div>
                                            <p class="text-2xl font-bold text-gray-900">${sales.reduce((acc, sale) => acc + sale.items.length, 0)}</p>
                                            <p class="text-sm text-gray-600">Itens Vendidos</p>
                                        </div>
                                        <div>
                                            <p class="text-2xl font-bold text-gray-900">${sales.length > 0 ? formatCurrency(totalSales / sales.length) : 'R$ 0,00'}</p>
                                            <p class="text-sm text-gray-600">Ticket M√©dio</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Confer√™ncia de Caixa -->
                            <div class="mb-6">
                                <h4 class="text-lg font-medium text-gray-900 mb-3">Confer√™ncia de Caixa</h4>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <p class="text-sm text-yellow-800 mb-3">
                                        <strong>Valor esperado no caixa:</strong> ${formatCurrency(finalBalance)}
                                    </p>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor real contado no caixa:</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-2 text-gray-500">R$</span>
                                            <input type="number" id="counted-amount" step="0.01" min="0" 
                                                   value="${finalBalance}" 
                                                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div id="difference-display" class="mt-2 text-sm"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Observa√ß√µes de Fechamento -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes de Fechamento</label>
                                <textarea id="closing-notes" rows="3" placeholder="Observa√ß√µes sobre o fechamento do caixa..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button onclick="generateCashierReport()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Gerar Relat√≥rio PDF
                                </button>
                                <button onclick="confirmCloseCashier(${finalBalance})" 
                                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                    Fechar Caixa
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modal-container').innerHTML = modalHtml;
                
                // Update difference calculation
                document.getElementById('counted-amount').addEventListener('input', function() {
                    const countedAmount = parseFloat(this.value) || 0;
                    const difference = countedAmount - finalBalance;
                    const diffDisplay = document.getElementById('difference-display');
                    
                    if (difference === 0) {
                        diffDisplay.innerHTML = '<span class="text-green-600 font-medium">‚úì Caixa confere</span>';
                    } else if (difference > 0) {
                        diffDisplay.innerHTML = `<span class="text-blue-600 font-medium">Sobra: ${formatCurrency(difference)}</span>`;
                    } else {
                        diffDisplay.innerHTML = `<span class="text-red-600 font-medium">Falta: ${formatCurrency(Math.abs(difference))}</span>`;
                    }
                });
                
                // Trigger initial calculation
                document.getElementById('counted-amount').dispatchEvent(new Event('input'));
                
            } catch (error) {
                console.error('Error preparing cashier close:', error);
                showToast('Erro ao preparar fechamento do caixa', 'error');
            }
        }

        async function confirmCloseCashier(expectedAmount) {
            const countedAmount = parseFloat(document.getElementById('counted-amount').value) || 0;
            const closingNotes = document.getElementById('closing-notes').value;
            const difference = countedAmount - expectedAmount;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                await db.collection('cashier').doc(today).update({
                    isOpen: false,
                    closedBy: currentUser.id,
                    closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expectedAmount: expectedAmount,
                    countedAmount: countedAmount,
                    difference: difference,
                    closingNotes: closingNotes
                });
                
                showToast('Caixa fechado com sucesso!');
                closeModal();
                await checkCashierStatus();
                if (currentSection === 'cashier') {
                    loadCashier();
                }
            } catch (error) {
                console.error('Error closing cashier:', error);
                showToast('Erro ao fechar caixa', 'error');
            }
        }

        async function generateCashierReport() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const cashierDoc = await db.collection('cashier').doc(today).get();
                
                if (!cashierDoc.exists) {
                    showToast('Dados do caixa n√£o encontrados', 'error');
                    return;
                }
                
                const cashierData = cashierDoc.data();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Relat√≥rio de Caixa', 20, 30);
                doc.setFontSize(12);
                doc.text(`Data: ${formatDate(new Date())}`, 20, 45);
                doc.text(`Operador: ${currentUser.name}`, 20, 55);
                
                // Financial summary
                let y = 75;
                doc.setFontSize(14);
                doc.text('Resumo Financeiro', 20, y);
                y += 15;
                
                doc.setFontSize(10);
                const movements = cashierData.movements || [];
                const sales = cashierData.sales || [];
                
                let totalIn = cashierData.initialAmount || 0;
                let totalOut = 0;
                let totalSales = 0;
                let totalWithdrawals = 0;
                
                movements.forEach(movement => {
                    if (movement.type === 'entrada') totalIn += movement.amount;
                    else if (movement.type === 'saida') totalOut += movement.amount;
                    else if (movement.type === 'retirada') totalWithdrawals += movement.amount;
                });
                
                sales.forEach(sale => totalSales += sale.total);
                
                doc.text(`Valor Inicial: ${formatCurrency(cashierData.initialAmount || 0)}`, 20, y);
                doc.text(`Total de Vendas: ${formatCurrency(totalSales)}`, 20, y + 10);
                doc.text(`Total de Retiradas: ${formatCurrency(totalWithdrawals)}`, 20, y + 20);
                doc.text(`Saldo Final: ${formatCurrency(totalIn + totalSales - totalOut - totalWithdrawals)}`, 20, y + 30);
                
                // Sales details
                y += 50;
                doc.setFontSize(14);
                doc.text('Detalhes das Vendas', 20, y);
                y += 15;
                
                doc.setFontSize(10);
                doc.text(`Total de Vendas: ${sales.length}`, 20, y);
                doc.text(`Itens Vendidos: ${sales.reduce((acc, sale) => acc + sale.items.length, 0)}`, 20, y + 10);
                doc.text(`Ticket M√©dio: ${sales.length > 0 ? formatCurrency(totalSales / sales.length) : 'R$ 0,00'}`, 20, y + 20);
                
                doc.save(`relatorio-caixa-${today}.pdf`);
                showToast('Relat√≥rio gerado com sucesso!');
                
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Erro ao gerar relat√≥rio', 'error');
            }
        }

        async function addWithdrawal() {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Fazer Retirada</h3>
                        <form id="withdrawal-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor da Retirada</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500">R$</span>
                                        <input type="number" id="withdrawal-amount" step="0.01" min="0" required
                                               placeholder="0,00" 
                                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da Retirada</label>
                                    <select id="withdrawal-reason" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Selecione o motivo</option>
                                        <option value="Troco">Troco</option>
                                        <option value="Despesas">Despesas</option>
                                        <option value="Pagamento">Pagamento</option>
                                        <option value="Banco">Dep√≥sito no Banco</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="withdrawal-notes" rows="2" placeholder="Detalhes da retirada..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                                    Confirmar Retirada
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('withdrawal-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById('withdrawal-amount').value);
                const reason = document.getElementById('withdrawal-reason').value;
                const notes = document.getElementById('withdrawal-notes').value;
                
                if (isNaN(amount) || amount <= 0) {
                    showToast('Valor inv√°lido', 'error');
                    return;
                }
                
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const cashierRef = db.collection('cashier').doc(today);
                    
                    await cashierRef.update({
                        movements: firebase.firestore.FieldValue.arrayUnion({
                            type: 'retirada',
                            description: `${reason}${notes ? ' - ' + notes : ''}`,
                            amount: amount,
                            reason: reason,
                            notes: notes,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: currentUser.id
                        })
                    });
                    
                    showToast('Retirada registrada com sucesso!');
                    closeModal();
                    if (currentSection === 'cashier') {
                        loadCashier();
                    }
                    
                } catch (error) {
                    console.error('Error adding withdrawal:', error);
                    showToast('Erro ao registrar retirada', 'error');
                }
            });
        }

        function initializeCashierSearch() {
            const searchInput = document.getElementById('search-items');
            const searchResults = document.getElementById('search-results');
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const clearCartBtn = document.getElementById('clear-cart');
            const completeSaleBtn = document.getElementById('complete-sale');
            
            if (!searchInput) return;
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim().toLowerCase();
                
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    await performSearch(query);
                }, 300);
            });
            
            // Clear cart
            clearCartBtn.addEventListener('click', function() {
                currentCart = [];
                updateCartDisplay();
            });
            
            // Complete sale
            completeSaleBtn.addEventListener('click', async function() {
                if (currentCart.length === 0) {
                    showToast('Adicione itens ao carrinho', 'error');
                    return;
                }
                
                await completeSale();
            });
            
            async function performSearch(query) {
                try {
                    const [servicesSnapshot, productsSnapshot] = await Promise.all([
                        db.collection('services').get(),
                        db.collection('products').get()
                    ]);
                    
                    const results = [];
                    
                    // Search services
                    servicesSnapshot.forEach(doc => {
                        const service = doc.data();
                        if (service.name.toLowerCase().includes(query)) {
                            results.push({
                                id: doc.id,
                                name: service.name,
                                price: service.price,
                                type: 'service',
                                duration: service.duration,
                                weeklyPrices: service.weeklyPrices
                            });
                        }
                    });
                    
                    // Search products
                    productsSnapshot.forEach(doc => {
                        const product = doc.data();
                        if (product.name.toLowerCase().includes(query) && product.stock > 0) {
                            results.push({
                                id: doc.id,
                                name: product.name,
                                price: product.price,
                                type: 'product',
                                stock: product.stock
                            });
                        }
                    });
                    
                    displaySearchResults(results);
                    
                } catch (error) {
                    console.error('Error searching items:', error);
                    showToast('Erro na busca', 'error');
                }
            }
            
            function displaySearchResults(results) {
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="p-3 text-gray-500 text-sm">Nenhum item encontrado</div>';
                    searchResults.classList.remove('hidden');
                    return;
                }
                
                let html = '';
                results.forEach(item => {
                    const typeIcon = item.type === 'service' ? '‚úÇÔ∏è' : 'üì¶';
                    const typeText = item.type === 'service' ? 'Servi√ßo' : 'Produto';
                    const priceDisplay = item.weeklyPrices ? 
                        `${formatCurrency(Math.min(...Object.values(item.weeklyPrices)))} - ${formatCurrency(Math.max(...Object.values(item.weeklyPrices)))}` :
                        formatCurrency(item.price);
                    
                    html += `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                             onclick="addToCart('${item.id}', '${item.name}', ${item.price}, '${item.type}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span>${typeIcon}</span>
                                        <span class="font-medium text-gray-900">${item.name}</span>
                                        <span class="text-xs text-gray-500">${typeText}</span>
                                    </div>
                                    ${item.type === 'product' ? `<div class="text-xs text-gray-500">Estoque: ${item.stock}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="font-medium text-gray-900">${priceDisplay}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                searchResults.innerHTML = html;
                searchResults.classList.remove('hidden');
            }
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
            
            function updateCartDisplay() {
                if (currentCart.length === 0) {
                    cartItems.innerHTML = '<p class="text-gray-500 text-sm text-center py-8">Nenhum item adicionado</p>';
                    cartTotal.textContent = 'R$ 0,00';
                    return;
                }
                
                let html = '';
                let total = 0;
                
                currentCart.forEach((item, index) => {
                    total += item.price * item.quantity;
                    const typeIcon = item.type === 'service' ? '‚úÇÔ∏è' : 'üì¶';
                    
                    html += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <span>${typeIcon}</span>
                                <div>
                                    <div class="font-medium text-gray-900">${item.name}</div>
                                    <div class="text-sm text-gray-500">${formatCurrency(item.price)} x ${item.quantity}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="changeQuantity(${index}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">-</button>
                                <span class="w-8 text-center">${item.quantity}</span>
                                <button onclick="changeQuantity(${index}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600">+</button>
                                <button onclick="removeFromCart(${index})" class="ml-2 text-red-500 hover:text-red-700">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = html;
                cartTotal.textContent = formatCurrency(total);
            }
            
            // Make functions global for onclick handlers
            window.addToCart = function(id, name, price, type) {
                const existingIndex = currentCart.findIndex(item => item.id === id);
                
                if (existingIndex >= 0) {
                    currentCart[existingIndex].quantity += 1;
                } else {
                    currentCart.push({
                        id: id,
                        name: name,
                        price: price,
                        type: type,
                        quantity: 1
                    });
                }
                
                updateCartDisplay();
                searchResults.classList.add('hidden');
                searchInput.value = '';
                showToast(`${name} adicionado ao carrinho`);
            };
            
            window.changeQuantity = function(index, change) {
                if (currentCart[index]) {
                    currentCart[index].quantity += change;
                    if (currentCart[index].quantity <= 0) {
                        currentCart.splice(index, 1);
                    }
                    updateCartDisplay();
                }
            };
            
            window.removeFromCart = function(index) {
                if (currentCart[index]) {
                    currentCart.splice(index, 1);
                    updateCartDisplay();
                }
            };
            
            async function completeSale() {
                if (currentCart.length === 0) return;
                
                const paymentMethod = document.getElementById('payment-method').value;
                if (!paymentMethod) {
                    showToast('Selecione o m√©todo de pagamento', 'error');
                    return;
                }
                
                try {
                    const total = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const saleId = Date.now().toString();
                    const now = new Date();
                    
                    const today = new Date().toISOString().split('T')[0];
                    const cashierRef = db.collection('cashier').doc(today);
                    
                    // Check if cashier document exists and is open
                    const cashierDoc = await cashierRef.get();
                    if (!cashierDoc.exists) {
                        showToast('Caixa n√£o encontrado. Abra o caixa primeiro.', 'error');
                        return;
                    }
                    
                    const cashierData = cashierDoc.data();
                    if (!cashierData.isOpen) {
                        showToast('Caixa n√£o est√° aberto. Abra o caixa primeiro.', 'error');
                        return;
                    }
                    
                    // Verify stock availability for all products before proceeding
                    const batch = db.batch();
                    for (const item of currentCart) {
                        if (item.type === 'product') {
                            const productRef = db.collection('products').doc(item.id);
                            const productDoc = await productRef.get();
                            
                            if (!productDoc.exists) {
                                showToast(`Produto ${item.name} n√£o encontrado`, 'error');
                                return;
                            }
                            
                            const currentStock = productDoc.data().stock || 0;
                            if (currentStock < item.quantity) {
                                showToast(`Estoque insuficiente para ${item.name}. Dispon√≠vel: ${currentStock}`, 'error');
                                return;
                            }
                            
                            // Add stock update to batch
                            batch.update(productRef, {
                                stock: firebase.firestore.FieldValue.increment(-item.quantity)
                            });
                        }
                    }
                    
                    // Calculate commissions
                    let servicesTotal = 0;
                    let productsTotal = 0;
                    
                    currentCart.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        if (item.type === 'service') {
                            servicesTotal += itemTotal;
                        } else if (item.type === 'product') {
                            productsTotal += itemTotal;
                        }
                    });
                    
                    const serviceCommission = (servicesTotal * (currentUser.serviceCommissionPercentage || 0)) / 100;
                    const productCommission = (productsTotal * (currentUser.productCommissionPercentage || 0)) / 100;
                    const totalCommission = serviceCommission + productCommission;
                    
                    // Create sale data with regular timestamp (not serverTimestamp)
                    const saleData = {
                        id: saleId,
                        items: currentCart.map(item => ({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            quantity: item.quantity,
                            type: item.type,
                            subtotal: item.price * item.quantity
                        })),
                        total: total,
                        paymentMethod: paymentMethod,
                        servicesTotal: servicesTotal,
                        productsTotal: productsTotal,
                        serviceCommission: serviceCommission,
                        productCommission: productCommission,
                        totalCommission: totalCommission,
                        timestamp: {
                            seconds: Math.floor(now.getTime() / 1000),
                            nanoseconds: (now.getTime() % 1000) * 1000000
                        },
                        userId: currentUser.id,
                        userName: currentUser.name
                    };
                    
                    // Update cashier with sale using arrayUnion
                    await cashierRef.update({
                        sales: firebase.firestore.FieldValue.arrayUnion(saleData)
                    });
                    
                    // Commit stock updates
                    await batch.commit();
                    
                    const paymentIcons = {
                        'dinheiro': 'üíµ',
                        'cartao': 'üí≥',
                        'pix': 'üì±'
                    };
                    
                    showToast(`Venda finalizada! ${paymentIcons[paymentMethod]} ${formatCurrency(total)} | Sua comiss√£o: ${formatCurrency(totalCommission)}`);
                    currentCart = [];
                    updateCartDisplay();
                    document.getElementById('payment-method').value = '';
                    
                    // Reload dashboard and cashier section
                    if (currentSection === 'dashboard') {
                        loadDashboard();
                    } else if (currentSection === 'cashier') {
                        loadCashier();
                    }
                    
                } catch (error) {
                    console.error('Error completing sale:', error);
                    showToast('Erro ao finalizar venda: ' + (error.message || 'Erro desconhecido'), 'error');
                }
            }
            
            // Initial cart display
            updateCartDisplay();
        }

        // Edit Functions
        function editUser(userId, userData) {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Editar Usu√°rio</h3>
                        <form id="edit-user-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                    <input type="text" id="edit-user-name" value="${userData.name}" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="edit-user-email" value="${userData.email}" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Fun√ß√£o</label>
                                    <select id="edit-user-role" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="barbeiro" ${userData.role === 'barbeiro' ? 'selected' : ''}>Barbeiro</option>
                                        <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Administrador</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="edit-user-status" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="ativo" ${userData.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                        <option value="inativo" ${userData.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comiss√£o de Servi√ßos (%)</label>
                                    <input type="number" id="edit-user-service-commission" value="${userData.serviceCommissionPercentage || 0}" min="0" max="100" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comiss√£o de Produtos (%)</label>
                                    <input type="number" id="edit-user-product-commission" value="${userData.productCommissionPercentage || 0}" min="0" max="100" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nova Senha (deixe em branco para manter a atual)</label>
                                    <input type="password" id="edit-user-password" placeholder="Nova senha (opcional)"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('edit-user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const updateData = {
                    name: document.getElementById('edit-user-name').value,
                    email: document.getElementById('edit-user-email').value,
                    role: document.getElementById('edit-user-role').value,
                    status: document.getElementById('edit-user-status').value,
                    serviceCommissionPercentage: parseInt(document.getElementById('edit-user-service-commission').value),
                    productCommissionPercentage: parseInt(document.getElementById('edit-user-product-commission').value)
                };
                
                const newPassword = document.getElementById('edit-user-password').value;
                if (newPassword) {
                    updateData.password = newPassword;
                }
                
                try {
                    await db.collection('users').doc(userId).update(updateData);
                    showToast('Usu√°rio atualizado com sucesso!');
                    closeModal();
                    loadUsers();
                } catch (error) {
                    console.error('Error updating user:', error);
                    showToast('Erro ao atualizar usu√°rio', 'error');
                }
            });
        }

        function editService(serviceId, serviceData) {
            // Initialize weekly prices with default values
            const weeklyPrices = serviceData.weeklyPrices || {
                monday: serviceData.price || 0,
                tuesday: serviceData.price || 0,
                wednesday: serviceData.price || 0,
                thursday: serviceData.price || 0,
                friday: serviceData.price || 0,
                saturday: serviceData.price || 0,
                sunday: serviceData.price || 0
            };
            
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Editar Servi√ßo</h3>
                        <form id="edit-service-form">
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Servi√ßo</label>
                                        <input type="text" id="edit-service-name" value="${serviceData.name}" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Dura√ß√£o (minutos)</label>
                                        <input type="number" id="edit-service-duration" value="${serviceData.duration}" min="1" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                                    <textarea id="edit-service-description" rows="2" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${serviceData.description || ''}</textarea>
                                </div>

                                <div class="border-t pt-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-md font-medium text-gray-900">Pre√ßos por Dia da Semana</h4>
                                        <div class="flex items-center space-x-2">
                                            <input type="number" id="bulk-price" step="0.01" min="0" placeholder="Pre√ßo √∫nico"
                                                   class="px-3 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <button type="button" id="apply-bulk-price" 
                                                    class="px-3 py-1 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                                Aplicar a Todos
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="space-y-3">
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Segunda-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-monday" value="${weeklyPrices.monday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Ter√ßa-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-tuesday" value="${weeklyPrices.tuesday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Quarta-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-wednesday" value="${weeklyPrices.wednesday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Quinta-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-thursday" value="${weeklyPrices.thursday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700">Sexta-feira</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-friday" value="${weeklyPrices.friday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700 text-blue-600">S√°bado</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-saturday" value="${weeklyPrices.saturday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50">
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-sm font-medium text-gray-700 text-red-600">Domingo</label>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs text-gray-500">R$</span>
                                                    <input type="number" id="price-sunday" value="${weeklyPrices.sunday}" step="0.01" min="0" required
                                                           class="w-20 px-2 py-1 text-sm border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 bg-red-50">
                                                </div>
                                            </div>
                                            <div class="pt-2 border-t">
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="font-medium text-gray-700">Pre√ßo M√©dio:</span>
                                                    <span id="average-price" class="font-bold text-green-600">R$ 0,00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            // Function to calculate and update average price
            function updateAveragePrice() {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                let total = 0;
                let count = 0;
                
                days.forEach(day => {
                    const input = document.getElementById(`price-${day}`);
                    if (input && input.value) {
                        total += parseFloat(input.value) || 0;
                        count++;
                    }
                });
                
                const average = count > 0 ? total / count : 0;
                document.getElementById('average-price').textContent = formatCurrency(average);
            }
            
            // Add event listeners for price inputs
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                const input = document.getElementById(`price-${day}`);
                if (input) {
                    input.addEventListener('input', updateAveragePrice);
                }
            });
            
            // Bulk price application
            document.getElementById('apply-bulk-price').addEventListener('click', function() {
                const bulkPrice = document.getElementById('bulk-price').value;
                if (bulkPrice && parseFloat(bulkPrice) >= 0) {
                    days.forEach(day => {
                        const input = document.getElementById(`price-${day}`);
                        if (input) {
                            input.value = bulkPrice;
                        }
                    });
                    updateAveragePrice();
                    showToast('Pre√ßo aplicado a todos os dias!');
                } else {
                    showToast('Digite um pre√ßo v√°lido', 'error');
                }
            });
            
            // Initial average calculation
            updateAveragePrice();
            
            document.getElementById('edit-service-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Collect weekly prices
                const weeklyPrices = {};
                days.forEach(day => {
                    const input = document.getElementById(`price-${day}`);
                    weeklyPrices[day] = parseFloat(input.value) || 0;
                });
                
                // Calculate average price for backward compatibility
                const averagePrice = Object.values(weeklyPrices).reduce((sum, price) => sum + price, 0) / 7;
                
                const updateData = {
                    name: document.getElementById('edit-service-name').value,
                    price: averagePrice, // Keep for backward compatibility
                    weeklyPrices: weeklyPrices, // New weekly pricing structure
                    duration: parseInt(document.getElementById('edit-service-duration').value),
                    description: document.getElementById('edit-service-description').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    await db.collection('services').doc(serviceId).update(updateData);
                    showToast('Servi√ßo atualizado com sucesso!');
                    closeModal();
                    loadServices();
                } catch (error) {
                    console.error('Error updating service:', error);
                    showToast('Erro ao atualizar servi√ßo', 'error');
                }
            });
        }

        function editProduct(productId, productData) {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Editar Produto</h3>
                        <form id="edit-product-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                                    <input type="text" id="edit-product-name" value="${productData.name}" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo (R$)</label>
                                    <input type="number" id="edit-product-price" value="${productData.price}" step="0.01" min="0" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Estoque</label>
                                    <input type="number" id="edit-product-stock" value="${productData.stock || 0}" min="0" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                    <input type="text" id="edit-product-category" value="${productData.category || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                                    <textarea id="edit-product-description" rows="3" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${productData.description || ''}</textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const updateData = {
                    name: document.getElementById('edit-product-name').value,
                    price: parseFloat(document.getElementById('edit-product-price').value),
                    stock: parseInt(document.getElementById('edit-product-stock').value),
                    category: document.getElementById('edit-product-category').value,
                    description: document.getElementById('edit-product-description').value
                };
                
                try {
                    await db.collection('products').doc(productId).update(updateData);
                    showToast('Produto atualizado com sucesso!');
                    closeModal();
                    loadProducts();
                } catch (error) {
                    console.error('Error updating product:', error);
                    showToast('Erro ao atualizar produto', 'error');
                }
            });
        }

        // Delete Functions
        async function deleteUser(userId, userName) {
            if (!confirm(`Tem certeza que deseja excluir o usu√°rio "${userName}"?`)) return;
            
            try {
                await db.collection('users').doc(userId).delete();
                showToast('Usu√°rio exclu√≠do com sucesso!');
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Erro ao excluir usu√°rio', 'error');
            }
        }

        async function deleteService(serviceId, serviceName) {
            if (!confirm(`Tem certeza que deseja excluir o servi√ßo "${serviceName}"?`)) return;
            
            try {
                await db.collection('services').doc(serviceId).delete();
                showToast('Servi√ßo exclu√≠do com sucesso!');
                loadServices();
            } catch (error) {
                console.error('Error deleting service:', error);
                showToast('Erro ao excluir servi√ßo', 'error');
            }
        }

        async function deleteProduct(productId, productName) {
            if (!confirm(`Tem certeza que deseja excluir o produto "${productName}"?`)) return;
            
            try {
                await db.collection('products').doc(productId).delete();
                showToast('Produto exclu√≠do com sucesso!');
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('Erro ao excluir produto', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // Create Functions
        function createUser() {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Novo Usu√°rio</h3>
                        <form id="create-user-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                    <input type="text" id="create-user-name" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="create-user-email" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                    <input type="password" id="create-user-password" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Fun√ß√£o</label>
                                    <select id="create-user-role" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="barbeiro">Barbeiro</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="create-user-status" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comiss√£o de Servi√ßos (%)</label>
                                    <input type="number" id="create-user-service-commission" value="50" min="0" max="100" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comiss√£o de Produtos (%)</label>
                                    <input type="number" id="create-user-product-commission" value="30" min="0" max="100" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Criar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
            
            document.getElementById('create-user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userData = {
                    name: document.getElementById('create-user-name').value,
                    email: document.getElementById('create-user-email').value,
                    password: document.getElementById('create-user-password').value,
                    role: document.getElementById('create-user-role').value,
                    status: document.getElementById('create-user-status').value,
                    serviceCommissionPercentage: parseInt(document.getElementById('create-user-service-commission').value),
                    productCommissionPercentage: parseInt(document.getElementById('create-user-product-commission').value),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.id
                };
                
                try {
                    await db.collection('users').add(userData);
                    showToast('Usu√°rio criado com sucesso!');
                    closeModal();
                    loadUsers();
                } catch (error) {
                    console.error('Error creating user:', error);
                    showToast('Erro ao criar usu√°rio', 'error');
                }
            });
        }

        // Timeline navigation functions
        let currentDayOffset = 0;

        function previousDay() {
            currentDayOffset--;
            loadAppointments();
        }

        function nextDay() {
            currentDayOffset++;
            loadAppointments();
        }

        function goToToday() {
            currentDayOffset = 0;
            loadAppointments();
        }

        function createAppointmentAtTime(date, time) {
            // Pre-fill the appointment form with selected date and time
            createAppointment(date, time);
        }

        function viewAppointment(appointmentId, appointmentData) {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Detalhes do Agendamento</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Cliente</label>
                                        <p class="text-lg font-semibold text-gray-900">${appointmentData.clientName}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Servi√ßo</label>
                                        <p class="text-lg font-semibold text-gray-900">${appointmentData.serviceName}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Data</label>
                                        <p class="text-lg font-semibold text-gray-900">${formatDate(new Date(appointmentData.date))}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Hor√°rio</label>
                                        <p class="text-lg font-semibold text-gray-900">${appointmentData.time}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Dura√ß√£o</label>
                                        <p class="text-lg font-semibold text-gray-900">${appointmentData.serviceDuration || 30} minutos</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Valor</label>
                                        <p class="text-lg font-semibold text-green-600">${formatCurrency(appointmentData.totalValue || 0)}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-sm font-medium text-gray-600">Status</label>
                                <div class="mt-1">
                                    <select id="appointment-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="agendado" ${appointmentData.status === 'agendado' ? 'selected' : ''}>üìÖ Agendado</option>
                                        <option value="conclu√≠do" ${appointmentData.status === 'conclu√≠do' ? 'selected' : ''}>‚úÖ Conclu√≠do</option>
                                        <option value="cancelado" ${appointmentData.status === 'cancelado' ? 'selected' : ''}>‚ùå Cancelado</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${appointmentData.notes ? `
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Observa√ß√µes</label>
                                    <p class="mt-1 text-gray-900 bg-gray-50 p-3 rounded-lg">${appointmentData.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button onclick="closeModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                Fechar
                            </button>
                            <button onclick="updateAppointmentStatus('${appointmentId}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Atualizar Status
                            </button>
                            <button onclick="deleteAppointment('${appointmentId}', '${appointmentData.clientName}')" 
                                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
        }

        async function updateAppointmentStatus(appointmentId) {
            const newStatus = document.getElementById('appointment-status').value;
            
            try {
                await db.collection('appointments').doc(appointmentId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Status do agendamento atualizado!');
                closeModal();
                loadAppointments();
                
                // Reload dashboard if we're on it
                if (currentSection === 'dashboard') {
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error updating appointment status:', error);
                showToast('Erro ao atualizar status', 'error');
            }
        }

        async function deleteAppointment(appointmentId, clientName) {
            if (!confirm(`Tem certeza que deseja excluir o agendamento de ${clientName}?`)) return;
            
            try {
                await db.collection('appointments').doc(appointmentId).delete();
                showToast('Agendamento exclu√≠do com sucesso!');
                closeModal();
                loadAppointments();
                
                // Reload dashboard if we're on it
                if (currentSection === 'dashboard') {
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error deleting appointment:', error);
                showToast('Erro ao excluir agendamento', 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Update current date
            document.getElementById('current-date').textContent = formatDate(new Date());
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                // Show loading state
                const loginBtn = document.getElementById('login-btn');
                const loginText = document.getElementById('login-text');
                const loginSpinner = document.getElementById('login-spinner');
                
                loginBtn.disabled = true;
                loginText.textContent = 'Entrando...';
                loginSpinner.classList.remove('hidden');
                
                login(email, password).finally(() => {
                    loginBtn.disabled = false;
                    loginText.textContent = 'Entrar';
                    loginSpinner.classList.add('hidden');
                });
            });
            
            // Create demo user button
            document.getElementById('create-demo-user').addEventListener('click', async function() {
                this.textContent = 'Criando usu√°rio...';
                this.disabled = true;
                
                try {
                    await createFirstAdmin();
                } finally {
                    this.textContent = 'Criar usu√°rio de demonstra√ß√£o';
                    this.disabled = false;
                }
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // Quick actions
            document.querySelectorAll('[data-section]').forEach(button => {
                if (!button.classList.contains('nav-item')) {
                    button.addEventListener('click', function() {
                        const section = this.getAttribute('data-section');
                        showSection(section);
                    });
                }
            });
            
            // Mobile menu
            document.getElementById('mobile-menu-btn').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            });
            
            document.getElementById('sidebar-toggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('-translate-x-full');
            });
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLoginScreen();
                // Try to create first admin if none exists
                setTimeout(() => createFirstAdmin(), 2000);
            }
            
            // Add event listeners for new buttons
            document.addEventListener('click', function(e) {
                if (e.target.id === 'new-service-btn') {
                    createService();
                } else if (e.target.id === 'new-product-btn') {
                    createProduct();
                } else if (e.target.id === 'new-client-btn') {
                    createClient();
                } else if (e.target.id === 'new-appointment-btn') {
                    createAppointment();
                } else if (e.target.id === 'new-user-btn') {
                    createUser();
                }
            });
            
            // Initialize Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('business-title').textContent = config.business_name || defaultConfig.business_name;
                        document.getElementById('sidebar-title').textContent = config.business_name || defaultConfig.business_name;
                        document.getElementById('welcome-text').textContent = config.welcome_message || defaultConfig.welcome_message;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["business_name", config.business_name || defaultConfig.business_name],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
                    ])
                });
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99dff0ce32bbfe12',t:'MTc2MzA1NDQzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
